[
    {
        "id": "2de9a494ac1d6c71",
        "type": "tab",
        "label": "HVAC",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "7d41aab9fd0b6a3e",
        "type": "tab",
        "label": "ESP32",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "d02cf25fa8114475",
        "type": "tab",
        "label": "Energy",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "13aa577370e4c4d7",
        "type": "tab",
        "label": "Logs/Notifications",
        "disabled": false,
        "info": ""
    },
    {
        "id": "536b0e9eda614fd2",
        "type": "tab",
        "label": "Zigbee",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "67e1c6f6bd2fab57",
        "type": "tab",
        "label": "Automations",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "86c7bfe22f048e9c",
        "type": "tab",
        "label": "Tasmota",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "f1e538c1.0315f8",
        "type": "noraf-config",
        "name": "NORA",
        "group": "seceani",
        "twofactor": "off",
        "twofactorpin": "",
        "localexecution": true,
        "structure": "Seceani",
        "storeStateInContext": true,
        "disableValidationErrors": false,
        "sendDeviceNameAndLocation": false
    },
    {
        "id": "f569d34c.8c7ed",
        "type": "mqtt-broker",
        "name": "",
        "broker": "localhost",
        "port": "1883",
        "clientid": "node-red",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "sessionExpiry": ""
    },
    {
        "id": "3302889fa9b7cb44",
        "type": "noraf-config",
        "name": "NORA - test",
        "group": "test",
        "twofactor": "off",
        "twofactorpin": "",
        "localexecution": true,
        "structure": "",
        "storeStateInContext": true,
        "disableValidationErrors": false,
        "sendDeviceNameAndLocation": false
    },
    {
        "id": "89e46ce21c7f5128",
        "type": "nibe-config",
        "name": "nibe config",
        "address": "tcp://NIBE-06545022180002.local:0502",
        "registerFile": ""
    },
    {
        "id": "63bdbe3c09b491f2",
        "type": "influxdb",
        "hostname": "127.0.0.1",
        "port": "8086",
        "protocol": "http",
        "database": "database",
        "name": "",
        "usetls": false,
        "tls": "",
        "influxdbVersion": "2.0",
        "url": "http://homemedia.local:8086",
        "rejectUnauthorized": false
    },
    {
        "id": "50383ae4cbb82921",
        "type": "mpp-config",
        "name": "mpp serial",
        "path": "/dev/serial/by-id/usb-Prolific_Technology_Inc._USB-Serial_Controller_D-if00-port0"
    },
    {
        "id": "e18cedd70c93f843",
        "type": "ui_tab",
        "name": "pv",
        "icon": "wb_sunny",
        "disabled": false,
        "hidden": false
    },
    {
        "id": "46510dc1aab73a6d",
        "type": "ui_group",
        "name": "battery",
        "tab": "e18cedd70c93f843",
        "order": 2,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "9d1871108d73a07a",
        "type": "ui_group",
        "name": "power",
        "tab": "e18cedd70c93f843",
        "order": 3,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "e16800f51cf528e0",
        "type": "ui_base",
        "theme": {
            "name": "theme-custom",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#40618c",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "reset": false
            },
            "themeState": {
                "base-color": {
                    "default": "#4B7930",
                    "value": "#40618c",
                    "edited": true
                },
                "page-titlebar-backgroundColor": {
                    "value": "#40618c",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#111111",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#333333",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#6287b7",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#555555",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#333333",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#eeeeee",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#40618c",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#333333",
                    "edited": false
                },
                "base-font": {
                    "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
                }
            },
            "angularTheme": {
                "primary": "indigo",
                "accents": "blue",
                "warn": "red",
                "background": "grey",
                "palette": "light"
            }
        },
        "site": {
            "name": "Dashboard",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "lockMenu": "false",
            "allowTempTheme": "true",
            "dateFormat": "DD/MM/YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "827cf95cdf202cb4",
        "type": "ui_group",
        "name": "control",
        "tab": "e18cedd70c93f843",
        "order": 1,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "ba44977d7b6ec35b",
        "type": "ui_group",
        "name": "last year",
        "tab": "e18cedd70c93f843",
        "order": 7,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "3b7b403039fa5965",
        "type": "ui_group",
        "name": "last week",
        "tab": "e18cedd70c93f843",
        "order": 6,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "b53a900ec325bc65",
        "type": "ui_group",
        "name": "today",
        "tab": "e18cedd70c93f843",
        "order": 4,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "73c9d7077dcee7d3",
        "type": "ui_group",
        "name": "today vs yesterday",
        "tab": "e18cedd70c93f843",
        "order": 5,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "1e8ff3e2e8219b0c",
        "type": "ui_group",
        "name": "stats (all time)",
        "tab": "e18cedd70c93f843",
        "order": 8,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "dcaffe26d1b1ca2d",
        "type": "ui_tab",
        "name": "hvac",
        "icon": "dashboard",
        "disabled": false,
        "hidden": false
    },
    {
        "id": "a8684bfbe26d43a5",
        "type": "ui_group",
        "name": "control",
        "tab": "dcaffe26d1b1ca2d",
        "order": 1,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "4782433439596f2f",
        "type": "ui_group",
        "name": "current",
        "tab": "dcaffe26d1b1ca2d",
        "order": 2,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "af294a26a01766cc",
        "type": "ui_group",
        "name": "stats (-31 days)",
        "tab": "e18cedd70c93f843",
        "order": 9,
        "disp": true,
        "width": "6",
        "collapse": false,
        "className": ""
    },
    {
        "id": "ea0310ce54c9a43e",
        "type": "google-notify-config",
        "ipaddress": "192.168.68.233",
        "name": "Google Home Mini.Garage speaker",
        "language": "en",
        "playVolumeLevel": "30",
        "speakSlow": false,
        "mediaServerUrl": "",
        "mediaServerPort": "8098",
        "cacheFolder": "/tmp"
    },
    {
        "id": "dc32c722d4c93816",
        "type": "google-notify-config",
        "ipaddress": "192.168.68.191",
        "name": "Google Nest Hub.Kitchen display",
        "language": "en",
        "playVolumeLevel": "20",
        "speakSlow": true,
        "mediaServerUrl": "",
        "mediaServerPort": "8098",
        "cacheFolder": "/tmp"
    },
    {
        "id": "75f9992b7ac7471e",
        "type": "google-notify-config",
        "ipaddress": "192.168.68.72",
        "name": "Google Home Mini.Bedroom speaker",
        "language": "en",
        "playVolumeLevel": "20",
        "speakSlow": true,
        "mediaServerUrl": "",
        "mediaServerPort": "8098",
        "cacheFolder": "/tmp"
    },
    {
        "id": "719187bb860811ae",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "Fan speed (AZ30-GQ3)",
        "register": "40136",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "ventilation/speed-gq3",
        "filter": false,
        "x": 930,
        "y": 1340,
        "wires": [
            [
                "b3dde27634dd2e4c"
            ]
        ]
    },
    {
        "id": "975b4952ce9a0378",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "Fan speed (AZ30-GQ2)",
        "register": "40135",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "ventilation/speed-gq2",
        "filter": false,
        "x": 930,
        "y": 1280,
        "wires": [
            [
                "b3dde27634dd2e4c",
                "1896aecdf780a7aa"
            ]
        ]
    },
    {
        "id": "4b7ea65a94ecfaf3",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "Living setpoint (heat)",
        "register": "id:12802",
        "nibe": "89e46ce21c7f5128",
        "interval": "20",
        "timeout": "5",
        "force": false,
        "topic": "living/setpoint",
        "filter": true,
        "x": 840,
        "y": 760,
        "wires": [
            [
                "34e4236db446efad"
            ]
        ]
    },
    {
        "id": "8a2d91b19d4ef994",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "Bedroom setpoint (heat)",
        "register": "id:12803",
        "nibe": "89e46ce21c7f5128",
        "interval": "20",
        "timeout": "5",
        "force": false,
        "topic": "bedroom/setpoint",
        "filter": true,
        "x": 850,
        "y": 820,
        "wires": [
            [
                "34e4236db446efad"
            ]
        ]
    },
    {
        "id": "aa438942649ecf58",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "Living temp.",
        "register": "Roomsensor 2-1",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "living/temperature",
        "filter": false,
        "x": 130,
        "y": 840,
        "wires": [
            [
                "69a2359c3bf3f716",
                "53311fb42f728855"
            ]
        ]
    },
    {
        "id": "99b78cb07dd4c043",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "More hot water",
        "register": "30697",
        "nibe": "89e46ce21c7f5128",
        "interval": "300",
        "timeout": "5",
        "force": true,
        "topic": "more-hot-water",
        "filter": true,
        "x": 220,
        "y": 280,
        "wires": [
            [
                "1cd1125ce32c5aca"
            ]
        ]
    },
    {
        "id": "46b0b3fc4d086f1e",
        "type": "noraf-switch",
        "z": "2de9a494ac1d6c71",
        "devicename": "Ventilation Boost",
        "roomhint": "Service Room",
        "name": "",
        "passthru": false,
        "errorifstateunchaged": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ventilation-mode",
        "onvalue": "4",
        "onvalueType": "num",
        "offvalue": "0",
        "offvalueType": "num",
        "twofactor": "ack",
        "twofactorpin": "",
        "filter": true,
        "asyncCmd": false,
        "outputs": 1,
        "x": 570,
        "y": 200,
        "wires": [
            [
                "660188df0186d9af"
            ]
        ]
    },
    {
        "id": "1cd1125ce32c5aca",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "map",
        "func": "return [{\n    payload: msg.payload.value >= 1 ? 1 : 0,\n    topic: msg.topic,\n}, {\n    payload: msg.payload.value,\n    topic: msg.topic,\n}];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 435,
        "y": 280,
        "wires": [
            [
                "f07580f20f9c8e5f"
            ],
            [
                "8f15ab904a1f47fa"
            ]
        ],
        "l": false
    },
    {
        "id": "f07580f20f9c8e5f",
        "type": "noraf-switch",
        "z": "2de9a494ac1d6c71",
        "devicename": "More hot water",
        "roomhint": "Service Room",
        "name": "",
        "passthru": false,
        "errorifstateunchaged": false,
        "nora": "f1e538c1.0315f8",
        "topic": "more-hot-water",
        "onvalue": "1",
        "onvalueType": "num",
        "offvalue": "0",
        "offvalueType": "num",
        "twofactor": "ack",
        "twofactorpin": "",
        "filter": true,
        "asyncCmd": false,
        "outputs": 1,
        "x": 560,
        "y": 260,
        "wires": [
            [
                "660188df0186d9af"
            ]
        ]
    },
    {
        "id": "9f8ecdb12e5082f5",
        "type": "link in",
        "z": "2de9a494ac1d6c71",
        "name": "link in 8",
        "links": [
            "660188df0186d9af",
            "795f23756f1e446b",
            "7d7734e07932bc3c"
        ],
        "x": 75,
        "y": 160,
        "wires": [
            [
                "99b78cb07dd4c043",
                "8c036ed2e6442271",
                "eb6e60ce1508eee2"
            ]
        ]
    },
    {
        "id": "660188df0186d9af",
        "type": "link out",
        "z": "2de9a494ac1d6c71",
        "name": "link out 6",
        "mode": "link",
        "links": [
            "9f8ecdb12e5082f5"
        ],
        "x": 775,
        "y": 200,
        "wires": []
    },
    {
        "id": "df27d4e5b15bc14e",
        "type": "trigger",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "op1": "{\"value\":true}",
        "op2": "{\"value\":false}",
        "op1type": "json",
        "op2type": "json",
        "duration": "10",
        "extend": true,
        "overrideDelay": false,
        "units": "s",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 490,
        "y": 40,
        "wires": [
            [
                "3760822f76a88122"
            ]
        ]
    },
    {
        "id": "015082b95c8d867b",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "Living setpoint (cool)",
        "register": "id:12842",
        "nibe": "89e46ce21c7f5128",
        "interval": "20",
        "timeout": "5",
        "force": false,
        "topic": "living/setpoint",
        "filter": true,
        "x": 840,
        "y": 880,
        "wires": [
            [
                "34e4236db446efad"
            ]
        ]
    },
    {
        "id": "f259002bf50c8663",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "Bedroom setpoint (cool)",
        "register": "id:12843",
        "nibe": "89e46ce21c7f5128",
        "interval": "20",
        "timeout": "5",
        "force": false,
        "topic": "bedroom/setpoint",
        "filter": true,
        "x": 850,
        "y": 940,
        "wires": [
            [
                "34e4236db446efad"
            ]
        ]
    },
    {
        "id": "e56377cc659b2c95",
        "type": "noraf-thermostat",
        "z": "2de9a494ac1d6c71",
        "devicename": "Living Thermostat",
        "roomhint": "Living Room",
        "name": "living",
        "modes": "off,heat,cool",
        "unit": "C",
        "rangeMin": "18",
        "rangeMax": "25",
        "topic": "living",
        "passthru": false,
        "commandOnly": false,
        "queryOnly": false,
        "bufferRangeCelsius": "1",
        "nora": "f1e538c1.0315f8",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 270,
        "y": 1020,
        "wires": [
            [
                "a5df44a963725282"
            ]
        ]
    },
    {
        "id": "da510ff457d3be7d",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Humidity (AZ30-BM20)",
        "nibe": "89e46ce21c7f5128",
        "interval": "300",
        "timeout": "5",
        "force": false,
        "topic": "humidity",
        "filter": false,
        "x": 160,
        "y": 780,
        "wires": [
            [
                "69a2359c3bf3f716",
                "7c06dbcc62e62ed4"
            ]
        ]
    },
    {
        "id": "25ecd6270bd33719",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "th.in",
        "func": "if (msg.payload.value < -300) {\n    return;\n}\n\nconst parts = msg.topic.split('/');\nconst rooms = parts.length === 2\n    ? [parts[0]]\n    : (context.keys() ?? []);\nconst prop = parts[parts.length - 1];\n\nconst msgs = rooms.map(room => {\n    const state = {\n        ...(context.get(room) ?? {}),\n        mode: 'heat',\n    };\n    state[prop] = msg.payload.value;\n    context.set(room, state);\n    return { topic: room, payload: state };\n});\n\nreturn [msgs];\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 155,
        "y": 1020,
        "wires": [
            [
                "e56377cc659b2c95",
                "b7cb59e0445cf704"
            ]
        ],
        "l": false
    },
    {
        "id": "b7cb59e0445cf704",
        "type": "noraf-thermostat",
        "z": "2de9a494ac1d6c71",
        "devicename": "Office Thermostat",
        "roomhint": "Office",
        "name": "bedroom",
        "modes": "off,heat,cool",
        "unit": "C",
        "rangeMin": "18",
        "rangeMax": "25",
        "topic": "bedroom",
        "passthru": false,
        "commandOnly": false,
        "queryOnly": false,
        "bufferRangeCelsius": "1",
        "nora": "f1e538c1.0315f8",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 280,
        "y": 1080,
        "wires": [
            [
                "a5df44a963725282"
            ]
        ]
    },
    {
        "id": "a5df44a963725282",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "th.out",
        "func": "const propsToCopy = ['setpoint'];\nconst messages = propsToCopy.map(key => ({\n    topic: `${msg.topic}/${key}`,\n    payload: msg.payload[key],\n}));\nreturn [messages]",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 415,
        "y": 1020,
        "wires": [
            [
                "847b62e1d562ef8b"
            ]
        ],
        "l": false
    },
    {
        "id": "61d8d50274c6ed71",
        "type": "link out",
        "z": "2de9a494ac1d6c71",
        "name": "link out 8",
        "mode": "link",
        "links": [
            "50badacef6b71f47"
        ],
        "x": 605,
        "y": 1020,
        "wires": []
    },
    {
        "id": "50badacef6b71f47",
        "type": "link in",
        "z": "2de9a494ac1d6c71",
        "name": "link in 10",
        "links": [
            "61d8d50274c6ed71",
            "7d7734e07932bc3c"
        ],
        "x": 675,
        "y": 840,
        "wires": [
            [
                "8a2d91b19d4ef994",
                "f259002bf50c8663",
                "4b7ea65a94ecfaf3",
                "015082b95c8d867b"
            ]
        ]
    },
    {
        "id": "e12aab3001f9c07c",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "Bedroom temp.",
        "register": "Roomsensor 3-1",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "bedroom/temperature",
        "filter": false,
        "x": 140,
        "y": 900,
        "wires": [
            [
                "69a2359c3bf3f716",
                "f56a62ef10d0d84b"
            ]
        ]
    },
    {
        "id": "3760822f76a88122",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "online",
        "func": "const status = msg.payload.value ? 'restored' : 'lost';\nconst at = new Date().toLocaleString();\nlet afterText = '';\nif (!msg.payload.value) {\n    context.set('lost_at', new Date().getTime());\n} else {\n    let after = new Date().getTime() - context.get('lost_at');\n    let unit = 'sec';\n    after /= 1000;\n    if (after > 60) {\n        after /= 60;\n        unit = 'min';\n    }\n    if (after > 60) {\n        after /= 60;\n        unit = 'hour';\n    }\n    afterText = `, after ${after.toFixed(1)} ${unit}`\n}\n\nreturn [{\n    ...msg,\n    topic: 'online',\n}, {\n    payload: {\n        tag: \"nibe-connection\",\n        title: \"Nibe connection\",\n        body: `Nibe connection ${status} at ${at}${afterText}`,\n        silent: true,\n    }\n}];\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 40,
        "wires": [
            [
                "e41d6b0ea38ad5e3"
            ],
            [
                "79840687cbc01295"
            ]
        ]
    },
    {
        "id": "847b62e1d562ef8b",
        "type": "rbe",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 510,
        "y": 1020,
        "wires": [
            [
                "61d8d50274c6ed71"
            ]
        ]
    },
    {
        "id": "9d978d4c29e3fede",
        "type": "influxdb out",
        "z": "2de9a494ac1d6c71",
        "influxdb": "63bdbe3c09b491f2",
        "name": "db.home",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "home",
        "bucket": "home",
        "x": 300,
        "y": 1460,
        "wires": []
    },
    {
        "id": "dc49bf19798833ec",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "map",
        "func": "if (msg.payload.value < -300) {\n    return;\n}\n\nconst parts = msg.topic.split('/');\nconst measurement = parts[0];\nconst payload = parts.length === 1\n    ? msg.payload.value\n    : { [parts[1]]: msg.payload.value }\n\nreturn {\n    payload,\n    measurement,\n};\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 170,
        "y": 1460,
        "wires": [
            [
                "9d978d4c29e3fede"
            ]
        ]
    },
    {
        "id": "f0ba748f1ac0e5cb",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Current outdoor temperature (BT1)",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "outdoor/temperature-bt1",
        "filter": true,
        "x": 220,
        "y": 1160,
        "wires": [
            [
                "7ca97a871eef0253",
                "3228600d9d24a04c"
            ]
        ]
    },
    {
        "id": "3a75e22cbaeb5f90",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "map",
        "func": "if (msg.payload.value < -300) {\n    return;\n}\n\nconst [measurement, valueName] = msg.topic.split('/');\nreturn {\n    payload: { [valueName]: msg.payload.value },\n    measurement,\n};\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 170,
        "y": 1500,
        "wires": [
            [
                "192c99f16f9eaaee"
            ]
        ]
    },
    {
        "id": "192c99f16f9eaaee",
        "type": "influxdb out",
        "z": "2de9a494ac1d6c71",
        "influxdb": "63bdbe3c09b491f2",
        "name": "db.nibe",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "home",
        "bucket": "nibe",
        "x": 300,
        "y": 1500,
        "wires": []
    },
    {
        "id": "b24637742b59a545",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Supply line (BT2)",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "line/supply-bt2",
        "filter": true,
        "x": 170,
        "y": 1220,
        "wires": [
            [
                "7ca97a871eef0253"
            ]
        ]
    },
    {
        "id": "031d282094febaef",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Return line (BT3)",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "line/return-bt3",
        "filter": true,
        "x": 170,
        "y": 1280,
        "wires": [
            [
                "7ca97a871eef0253"
            ]
        ]
    },
    {
        "id": "dd47cceaba61a5f7",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Supp. air (AZ30-BT22)",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "ventilation/supp-air-temperature-bt22",
        "filter": true,
        "x": 560,
        "y": 1220,
        "wires": [
            [
                "772ab499b9243a81"
            ]
        ]
    },
    {
        "id": "996240fd23d720a0",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Outd temperature (AZ30-BT23)",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "ventilation/outdoor-temperature-bt23",
        "filter": true,
        "x": 590,
        "y": 1160,
        "wires": [
            [
                "772ab499b9243a81"
            ]
        ]
    },
    {
        "id": "5ec95ea45d80a286",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Extr. air (AZ30-BT21)",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "ventilation/extract-air-temp-bt21",
        "filter": true,
        "x": 560,
        "y": 1280,
        "wires": [
            [
                "772ab499b9243a81"
            ]
        ]
    },
    {
        "id": "63ba0783caa8bb63",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Exh. air (AZ30-BT20)",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "ventilation/exhaust-air-temp-bt20",
        "filter": true,
        "x": 560,
        "y": 1340,
        "wires": [
            [
                "772ab499b9243a81"
            ]
        ]
    },
    {
        "id": "890018e7cbc90cd7",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Priority",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "operation/priority",
        "filter": false,
        "x": 880,
        "y": 1460,
        "wires": [
            [
                "6c724be7f6fd897c",
                "cce88af52e63bf82",
                "b3dde27634dd2e4c"
            ]
        ]
    },
    {
        "id": "6c724be7f6fd897c",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "Priority",
        "func": "const map = {\n    '10': 'off',\n    '20': 'hot water',\n    '30': 'heat',\n    '40': 'pool',\n    '60': 'cooling',\n};\n\nconst mode = map[msg.payload.value];\n\nnode.status(mode);\n\nreturn {\n    payload: mode,\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1025,
        "y": 1500,
        "wires": [
            [
                "de81314094c70c91"
            ]
        ],
        "l": false
    },
    {
        "id": "52532f840d2ce09f",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Brine in (BT10)",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "brine/in-bt10",
        "filter": false,
        "x": 900,
        "y": 1160,
        "wires": [
            [
                "b3dde27634dd2e4c"
            ]
        ]
    },
    {
        "id": "31b0c9a4bf89bbab",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Brine out (BT11)",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "brine/out-bt11",
        "filter": false,
        "x": 900,
        "y": 1220,
        "wires": [
            [
                "b3dde27634dd2e4c"
            ]
        ]
    },
    {
        "id": "732ffd78751c6902",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Ventilation mode",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "ventilation/mode",
        "filter": false,
        "x": 550,
        "y": 1400,
        "wires": [
            [
                "772ab499b9243a81"
            ]
        ]
    },
    {
        "id": "8c036ed2e6442271",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Ventilation mode",
        "nibe": "89e46ce21c7f5128",
        "interval": "5",
        "timeout": "5",
        "force": false,
        "topic": "ventilation-mode",
        "filter": true,
        "x": 230,
        "y": 40,
        "wires": [
            [
                "7e80dd6fcb41cdda",
                "df27d4e5b15bc14e",
                "c5cf93edc9abdd07"
            ]
        ]
    },
    {
        "id": "7e80dd6fcb41cdda",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "map",
        "func": "node.status({ fill: \"blue\", text: `${msg.payload.value} - ${status()}` });\n\nreturn [{\n    payload: msg.payload.value === 1 ? 1 : 0,\n    topic: msg.topic,\n}, {\n    payload: msg.payload.value === 4 ? 4 : 0,\n    topic: msg.topic,\n}];\n\nfunction status() {\n    switch (msg.payload.value) {\n        case 0: return 'normal';\n        case 1: return 'off';\n        case 2: return 'low';\n        case 3: return 'high';\n        case 4: return 'boost';\n    }\n}",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 180,
        "wires": [
            [
                "f0a4665aecc7e7e1"
            ],
            [
                "46b0b3fc4d086f1e"
            ]
        ]
    },
    {
        "id": "f0a4665aecc7e7e1",
        "type": "noraf-switch",
        "z": "2de9a494ac1d6c71",
        "devicename": "Ventilation",
        "roomhint": "Service Room",
        "name": "",
        "passthru": false,
        "errorifstateunchaged": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ventilation-mode",
        "onvalue": "0",
        "onvalueType": "num",
        "offvalue": "1",
        "offvalueType": "num",
        "twofactor": "ack",
        "twofactorpin": "",
        "filter": true,
        "asyncCmd": false,
        "outputs": 1,
        "x": 550,
        "y": 140,
        "wires": [
            [
                "660188df0186d9af"
            ]
        ]
    },
    {
        "id": "7b6e8ee91a219ed4",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Hot water charging (BT6)",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "hot-water/charging-bt6",
        "filter": false,
        "x": 190,
        "y": 1340,
        "wires": [
            [
                "7ca97a871eef0253",
                "34d8b09cbd23088f"
            ]
        ]
    },
    {
        "id": "3b13ed9084ac3922",
        "type": "link in",
        "z": "2de9a494ac1d6c71",
        "name": "link in 19",
        "links": [
            "69a2359c3bf3f716",
            "34e4236db446efad"
        ],
        "x": 85,
        "y": 1460,
        "wires": [
            [
                "dc49bf19798833ec"
            ]
        ]
    },
    {
        "id": "69a2359c3bf3f716",
        "type": "link out",
        "z": "2de9a494ac1d6c71",
        "name": "temp+humidity",
        "mode": "link",
        "links": [
            "3b13ed9084ac3922",
            "ceabaec499757bb4"
        ],
        "x": 335,
        "y": 920,
        "wires": []
    },
    {
        "id": "ceabaec499757bb4",
        "type": "link in",
        "z": "2de9a494ac1d6c71",
        "name": "link in 20",
        "links": [
            "34e4236db446efad",
            "4495116d6ff821e7",
            "69a2359c3bf3f716",
            "e41d6b0ea38ad5e3"
        ],
        "x": 85,
        "y": 1020,
        "wires": [
            [
                "25ecd6270bd33719"
            ]
        ]
    },
    {
        "id": "e41d6b0ea38ad5e3",
        "type": "link out",
        "z": "2de9a494ac1d6c71",
        "name": "nibe online",
        "mode": "link",
        "links": [
            "ceabaec499757bb4"
        ],
        "x": 765,
        "y": 40,
        "wires": []
    },
    {
        "id": "34e4236db446efad",
        "type": "link out",
        "z": "2de9a494ac1d6c71",
        "name": "temp. setpoints",
        "mode": "link",
        "links": [
            "3b13ed9084ac3922",
            "ceabaec499757bb4"
        ],
        "x": 1025,
        "y": 840,
        "wires": []
    },
    {
        "id": "7ca97a871eef0253",
        "type": "link out",
        "z": "2de9a494ac1d6c71",
        "name": "link out 20",
        "mode": "link",
        "links": [
            "9443fc43a7aab52a",
            "47ae0eea20515ee1"
        ],
        "x": 415,
        "y": 1160,
        "wires": []
    },
    {
        "id": "9443fc43a7aab52a",
        "type": "link in",
        "z": "2de9a494ac1d6c71",
        "name": "link in 21",
        "links": [
            "772ab499b9243a81",
            "7ca97a871eef0253",
            "b3dde27634dd2e4c"
        ],
        "x": 85,
        "y": 1500,
        "wires": [
            [
                "3a75e22cbaeb5f90"
            ]
        ]
    },
    {
        "id": "772ab499b9243a81",
        "type": "link out",
        "z": "2de9a494ac1d6c71",
        "name": "link out 21",
        "mode": "link",
        "links": [
            "9443fc43a7aab52a",
            "47ae0eea20515ee1"
        ],
        "x": 775,
        "y": 1160,
        "wires": []
    },
    {
        "id": "b3dde27634dd2e4c",
        "type": "link out",
        "z": "2de9a494ac1d6c71",
        "name": "link out 22",
        "mode": "link",
        "links": [
            "9443fc43a7aab52a",
            "47ae0eea20515ee1"
        ],
        "x": 1095,
        "y": 1160,
        "wires": []
    },
    {
        "id": "0dd05f455560223e",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Operating mode",
        "nibe": "89e46ce21c7f5128",
        "interval": "60",
        "timeout": "5",
        "force": false,
        "topic": "operation/priority",
        "filter": false,
        "x": 900,
        "y": 1400,
        "wires": [
            [
                "777c440cff6e50f7"
            ]
        ]
    },
    {
        "id": "777c440cff6e50f7",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "op. mode",
        "func": "const map = new Map([\n    [0, 'auto'],\n    [1, 'manual'],\n    [2, 'add. heat only'],\n]);\n\nnode.status({\n    fill: 'blue',\n    text: map.get(msg.payload.value),\n});\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1060,
        "y": 1400,
        "wires": [
            []
        ]
    },
    {
        "id": "cce88af52e63bf82",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "map",
        "func": "return {\n    payload: {\n        value: msg.payload.value === 30\n            ? 'heat'\n            : 'none',\n    },\n    topic: 'activeMode',\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1025,
        "y": 1460,
        "wires": [
            [
                "4495116d6ff821e7"
            ]
        ],
        "l": false
    },
    {
        "id": "4495116d6ff821e7",
        "type": "link out",
        "z": "2de9a494ac1d6c71",
        "name": "thermostat active mode",
        "mode": "link",
        "links": [
            "ceabaec499757bb4"
        ],
        "x": 1075,
        "y": 1460,
        "wires": []
    },
    {
        "id": "79840687cbc01295",
        "type": "noraf-notify",
        "z": "2de9a494ac1d6c71",
        "tag": "",
        "title": "",
        "body": "",
        "icon": "",
        "name": "notify",
        "nora": "f1e538c1.0315f8",
        "topic": "",
        "actions": [],
        "closeNotification": false,
        "x": 790,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "3228600d9d24a04c",
        "type": "change",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "outdoorTemperature",
                "pt": "global",
                "to": "payload.value",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 590,
        "y": 1480,
        "wires": [
            []
        ]
    },
    {
        "id": "46fcb561cc16d521",
        "type": "ui_dropdown",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "label": "vent. mode",
        "tooltip": "",
        "place": "Select option",
        "group": "a8684bfbe26d43a5",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "multiple": false,
        "options": [
            {
                "label": "off",
                "value": 1,
                "type": "num"
            },
            {
                "label": "normal",
                "value": 0,
                "type": "num"
            },
            {
                "label": "low",
                "value": 2,
                "type": "num"
            },
            {
                "label": "high",
                "value": 3,
                "type": "num"
            },
            {
                "label": "boost",
                "value": 4,
                "type": "num"
            }
        ],
        "payload": "",
        "topic": "ventilation-mode",
        "topicType": "str",
        "className": "equal-space",
        "x": 630,
        "y": 80,
        "wires": [
            [
                "660188df0186d9af"
            ]
        ]
    },
    {
        "id": "c5cf93edc9abdd07",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "function 4",
        "func": "return {\n    payload: msg.payload.value,\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 475,
        "y": 80,
        "wires": [
            [
                "4308a38a3f98b67d"
            ]
        ],
        "l": false
    },
    {
        "id": "7e188979b4c7dc7c",
        "type": "ui_text",
        "z": "2de9a494ac1d6c71",
        "group": "4782433439596f2f",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "humidity",
        "format": "{{msg.payload.value}}%",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 460,
        "y": 800,
        "wires": []
    },
    {
        "id": "4308a38a3f98b67d",
        "type": "rbe",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 525,
        "y": 80,
        "wires": [
            [
                "46fcb561cc16d521"
            ]
        ],
        "l": false
    },
    {
        "id": "7c06dbcc62e62ed4",
        "type": "rbe",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 335,
        "y": 800,
        "wires": [
            [
                "7e188979b4c7dc7c",
                "5b628d2ea4d3b191"
            ]
        ],
        "l": false
    },
    {
        "id": "7adfef4f1054da24",
        "type": "ui_text",
        "z": "2de9a494ac1d6c71",
        "group": "4782433439596f2f",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "living",
        "format": "{{msg.payload.value}}°C",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 450,
        "y": 840,
        "wires": []
    },
    {
        "id": "53311fb42f728855",
        "type": "rbe",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 335,
        "y": 840,
        "wires": [
            [
                "7adfef4f1054da24"
            ]
        ],
        "l": false
    },
    {
        "id": "9c92fd2b8c07cccc",
        "type": "ui_text",
        "z": "2de9a494ac1d6c71",
        "group": "4782433439596f2f",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "bedroom",
        "format": "{{msg.payload.value}}°C",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 460,
        "y": 880,
        "wires": []
    },
    {
        "id": "f56a62ef10d0d84b",
        "type": "rbe",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 335,
        "y": 880,
        "wires": [
            [
                "9c92fd2b8c07cccc"
            ]
        ],
        "l": false
    },
    {
        "id": "19f31d77ba8ef94d",
        "type": "ui_text",
        "z": "2de9a494ac1d6c71",
        "group": "4782433439596f2f",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "operation mode",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 1200,
        "y": 1500,
        "wires": []
    },
    {
        "id": "de81314094c70c91",
        "type": "rbe",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 1075,
        "y": 1500,
        "wires": [
            [
                "19f31d77ba8ef94d"
            ]
        ],
        "l": false
    },
    {
        "id": "bcec952a1fce8e05",
        "type": "ui_text",
        "z": "2de9a494ac1d6c71",
        "group": "4782433439596f2f",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "hot water",
        "format": "{{msg.payload.value}}°C",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 340,
        "y": 1400,
        "wires": []
    },
    {
        "id": "34d8b09cbd23088f",
        "type": "rbe",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 235,
        "y": 1400,
        "wires": [
            [
                "bcec952a1fce8e05"
            ]
        ],
        "l": false
    },
    {
        "id": "6851ce2590b301f2",
        "type": "ui_text",
        "z": "2de9a494ac1d6c71",
        "group": "4782433439596f2f",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "fan speed",
        "format": "{{msg.payload.value}}%",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 1210,
        "y": 1280,
        "wires": []
    },
    {
        "id": "1896aecdf780a7aa",
        "type": "rbe",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 1105,
        "y": 1280,
        "wires": [
            [
                "6851ce2590b301f2"
            ]
        ],
        "l": false
    },
    {
        "id": "c1759f343a87fbd5",
        "type": "ui_dropdown",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "label": "bypass recovery (heating)",
        "tooltip": "",
        "place": "Select option",
        "group": "a8684bfbe26d43a5",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "multiple": false,
        "options": [
            {
                "label": "auto",
                "value": "auto",
                "type": "str"
            },
            {
                "label": "on",
                "value": "on",
                "type": "str"
            },
            {
                "label": "off",
                "value": "off",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "equal-space",
        "x": 470,
        "y": 600,
        "wires": [
            [
                "82830d4f50d0d8b1"
            ]
        ]
    },
    {
        "id": "27d499b6a6e0d7e5",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "Bypass during heating",
        "register": "Bypass during heating (ERS 1)",
        "nibe": "89e46ce21c7f5128",
        "interval": "300",
        "timeout": "5",
        "force": false,
        "topic": "",
        "filter": false,
        "x": 340,
        "y": 660,
        "wires": [
            [
                "0cac7e4e32ee3a94"
            ]
        ]
    },
    {
        "id": "1895125bc221a5c6",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "decide",
        "func": "/** @type {'auto'|'on'|'off'} */\nconst bypassRecoveryMode = flow.get('bypassRecoveryMode') ?? 'auto';\n/** @type number */\nconst humidity = flow.get('humidity') ?? 0;\nif (humidity < 0 || humidity > 100) {\n    return;\n}\n\nconst outdoorTemperature = global.get('outdoorTemperature');\nconst stopRecovery = flow.get('currentBypassRecovery') === 1;\nconst target = flow.get('targetHumidity') ?? 45;\nconst histerezis = 1;\nconst compareTo = target + (stopRecovery ? 0 : 1) * histerezis;\n\n/** @type boolean */\nlet shouldStopRecovery;\n\nif (bypassRecoveryMode === 'auto') {\n    shouldStopRecovery = outdoorTemperature < 10\n        ? humidity >= compareTo\n        : false;\n} else {\n    shouldStopRecovery = bypassRecoveryMode === 'on';\n}\n\nnode.status({\n    fill: shouldStopRecovery ? 'red' : \"blue\",\n    shape: \"dot\",\n    text: `recovery ${shouldStopRecovery ? 'off' : 'on'}`,\n});\n\nreturn {\n    payload: shouldStopRecovery ? 1 : 0,\n};\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 170,
        "y": 660,
        "wires": [
            [
                "27d499b6a6e0d7e5"
            ]
        ]
    },
    {
        "id": "a89a7d1a69791e64",
        "type": "inject",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "5",
        "topic": "",
        "payload": "bypassRecoveryMode",
        "payloadType": "flow",
        "x": 200,
        "y": 600,
        "wires": [
            [
                "c1759f343a87fbd5"
            ]
        ]
    },
    {
        "id": "82830d4f50d0d8b1",
        "type": "change",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "bypassRecoveryMode",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 600,
        "wires": [
            [
                "b6935da713247650"
            ]
        ]
    },
    {
        "id": "5b628d2ea4d3b191",
        "type": "change",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "humidity",
                "pt": "flow",
                "to": "payload.value",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 480,
        "y": 760,
        "wires": [
            [
                "b7753e62e5172138"
            ]
        ]
    },
    {
        "id": "a2fc284adb73a57c",
        "type": "rbe",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 525,
        "y": 660,
        "wires": [
            [
                "f1e2ba3b1ad0334a",
                "e4f37dabebfec6aa"
            ]
        ],
        "l": false
    },
    {
        "id": "f1e2ba3b1ad0334a",
        "type": "change",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "currentBypassRecovery",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 710,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "0cac7e4e32ee3a94",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "function 6",
        "func": "return {\n    payload: msg.payload.value,\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 475,
        "y": 660,
        "wires": [
            [
                "a2fc284adb73a57c"
            ]
        ],
        "l": false
    },
    {
        "id": "fd568b4575571252",
        "type": "ui_slider",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "label": "target humidity",
        "tooltip": "",
        "group": "a8684bfbe26d43a5",
        "order": 3,
        "width": 0,
        "height": 0,
        "passthru": false,
        "outs": "end",
        "topic": "topic",
        "topicType": "msg",
        "min": "30",
        "max": "60",
        "step": 1,
        "className": "",
        "x": 440,
        "y": 540,
        "wires": [
            [
                "0bec653360a02da9"
            ]
        ]
    },
    {
        "id": "0bec653360a02da9",
        "type": "change",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "targetHumidity",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 720,
        "y": 540,
        "wires": [
            [
                "b6935da713247650"
            ]
        ]
    },
    {
        "id": "bb63d55c54c78a93",
        "type": "inject",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "5",
        "topic": "",
        "payload": "targetHumidity",
        "payloadType": "flow",
        "x": 170,
        "y": 540,
        "wires": [
            [
                "fd568b4575571252"
            ]
        ]
    },
    {
        "id": "e4f37dabebfec6aa",
        "type": "ui_text",
        "z": "2de9a494ac1d6c71",
        "group": "4782433439596f2f",
        "order": 6,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "bypass recovery",
        "format": "{{msg.payload ? 'on' : 'off'}}",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 660,
        "y": 700,
        "wires": []
    },
    {
        "id": "b6935da713247650",
        "type": "link out",
        "z": "2de9a494ac1d6c71",
        "name": "link out 35",
        "mode": "link",
        "links": [
            "10d36d8a03faef1a"
        ],
        "x": 955,
        "y": 580,
        "wires": []
    },
    {
        "id": "10d36d8a03faef1a",
        "type": "link in",
        "z": "2de9a494ac1d6c71",
        "name": "link in 35",
        "links": [
            "b6935da713247650",
            "b7753e62e5172138"
        ],
        "x": 75,
        "y": 660,
        "wires": [
            [
                "1895125bc221a5c6"
            ]
        ]
    },
    {
        "id": "b7753e62e5172138",
        "type": "link out",
        "z": "2de9a494ac1d6c71",
        "name": "link out 36",
        "mode": "link",
        "links": [
            "10d36d8a03faef1a"
        ],
        "x": 595,
        "y": 760,
        "wires": []
    },
    {
        "id": "eb6e60ce1508eee2",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Hot water demand mode",
        "nibe": "89e46ce21c7f5128",
        "interval": "300",
        "timeout": "5",
        "force": false,
        "topic": "hot-water-demand",
        "filter": true,
        "x": 250,
        "y": 380,
        "wires": [
            [
                "afe81ebbf0f87807"
            ]
        ]
    },
    {
        "id": "02ce6201851d30ac",
        "type": "ui_dropdown",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "label": "hot water demand",
        "tooltip": "",
        "place": "Select option",
        "group": "a8684bfbe26d43a5",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "multiple": false,
        "options": [
            {
                "label": "small",
                "value": 0,
                "type": "num"
            },
            {
                "label": "medium",
                "value": 1,
                "type": "num"
            },
            {
                "label": "large",
                "value": 2,
                "type": "num"
            },
            {
                "label": "smart",
                "value": "4",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "hot-water-demand",
        "topicType": "str",
        "className": "equal-space",
        "x": 570,
        "y": 380,
        "wires": [
            [
                "660188df0186d9af"
            ]
        ]
    },
    {
        "id": "afe81ebbf0f87807",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "map",
        "func": "return {\n    payload: msg.payload.value,\n    topic: msg.topic,\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 435,
        "y": 380,
        "wires": [
            [
                "02ce6201851d30ac"
            ]
        ],
        "l": false
    },
    {
        "id": "8f15ab904a1f47fa",
        "type": "ui_dropdown",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "label": "more hot water",
        "tooltip": "",
        "place": "Select option",
        "group": "a8684bfbe26d43a5",
        "order": 1,
        "width": 0,
        "height": 0,
        "passthru": false,
        "multiple": false,
        "options": [
            {
                "label": "off",
                "value": 0,
                "type": "num"
            },
            {
                "label": "1h",
                "value": 1,
                "type": "num"
            },
            {
                "label": "one time",
                "value": 2,
                "type": "num"
            },
            {
                "label": "3h",
                "value": 3,
                "type": "num"
            },
            {
                "label": "6h",
                "value": 6,
                "type": "num"
            },
            {
                "label": "12h",
                "value": 12,
                "type": "num"
            },
            {
                "label": "24h",
                "value": 24,
                "type": "num"
            },
            {
                "label": "48h",
                "value": 48,
                "type": "num"
            }
        ],
        "payload": "",
        "topic": "more-hot-water",
        "topicType": "str",
        "className": "equal-space",
        "x": 560,
        "y": 320,
        "wires": [
            [
                "660188df0186d9af"
            ]
        ]
    },
    {
        "id": "5822e7dc66286433",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Heating offset climate system 1",
        "nibe": "89e46ce21c7f5128",
        "interval": "300",
        "timeout": "5",
        "force": false,
        "topic": "climate-1",
        "filter": true,
        "x": 1190,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "ea99da76979117dc",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Heating offset climate system 2",
        "nibe": "89e46ce21c7f5128",
        "interval": "300",
        "timeout": "5",
        "force": false,
        "topic": "climate-2",
        "filter": true,
        "x": 1190,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "7a718bf4f4e4dca5",
        "type": "nibe-register",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "register": "Heating offset climate system 3",
        "nibe": "89e46ce21c7f5128",
        "interval": "300",
        "timeout": "5",
        "force": false,
        "topic": "climate-3",
        "filter": true,
        "x": 1190,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "d9397a1c58ee36eb",
        "type": "function",
        "z": "2de9a494ac1d6c71",
        "name": "map",
        "func": "const regular = [1, 1, 0];\nconst offset = [3, 0, 3];\nconst shouldIncrease = !!msg.payload;\n\nreturn [[\n    ...regular.map((v, index) => ({\n        payload: shouldIncrease ? v + offset[index] : v,\n        topic: `climate-${index + 1}`\n    })),\n    {\n        topic: 'bedroom/setpoint',\n        payload: shouldIncrease ? 25 : 21.5\n    },\n    {\n        topic: 'more-hot-water',\n        payload: shouldIncrease ? 6 : 0,\n    }\n]];",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 460,
        "wires": [
            [
                "5822e7dc66286433",
                "ea99da76979117dc",
                "7a718bf4f4e4dca5",
                "7d7734e07932bc3c"
            ]
        ]
    },
    {
        "id": "8da99f75ea38eea5",
        "type": "inject",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "true",
        "payloadType": "bool",
        "x": 770,
        "y": 440,
        "wires": [
            [
                "d9397a1c58ee36eb"
            ]
        ]
    },
    {
        "id": "5d8a5abee4d5a5b8",
        "type": "inject",
        "z": "2de9a494ac1d6c71",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "false",
        "payloadType": "bool",
        "x": 770,
        "y": 480,
        "wires": [
            [
                "d9397a1c58ee36eb"
            ]
        ]
    },
    {
        "id": "7d7734e07932bc3c",
        "type": "link out",
        "z": "2de9a494ac1d6c71",
        "name": "link out 37",
        "mode": "link",
        "links": [
            "50badacef6b71f47",
            "9f8ecdb12e5082f5"
        ],
        "x": 1075,
        "y": 580,
        "wires": []
    },
    {
        "id": "5bb98af947157223",
        "type": "node-espota",
        "z": "7d41aab9fd0b6a3e",
        "firmwareLink": "https://github.com/andrei-tatar/ha-wifi-switch/releases/latest/download/ha_switch_esp32.bin",
        "extractHost": "^ha-switch/(.+)/version$",
        "excludeHost": "switch-dimmer-8",
        "name": "",
        "x": 330,
        "y": 60,
        "wires": []
    },
    {
        "id": "f2dddb9e4756a85a",
        "type": "mqtt in",
        "z": "7d41aab9fd0b6a3e",
        "name": "",
        "topic": "ha-switch/+/version",
        "qos": "0",
        "datatype": "utf8",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 100,
        "wires": [
            [
                "5bb98af947157223"
            ]
        ]
    },
    {
        "id": "b5f045d301d04cf3",
        "type": "inject",
        "z": "7d41aab9fd0b6a3e",
        "name": "UPDATE",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "update",
        "payload": "",
        "payloadType": "date",
        "x": 140,
        "y": 60,
        "wires": [
            [
                "5bb98af947157223"
            ]
        ]
    },
    {
        "id": "f648133e35429919",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Main",
        "lightcolor": false,
        "brightnesscontrol": true,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": true,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Hallway",
        "name": "3. hallway - main",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-dimmer-3/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 750,
        "y": 200,
        "wires": [
            [
                "6af1216eb7c5c03f"
            ]
        ]
    },
    {
        "id": "8521a26270a7f5ed",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Dining",
        "lightcolor": false,
        "brightnesscontrol": true,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": true,
        "passthru": false,
        "errorifstateunchaged": true,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Living Room",
        "name": "12. living - dining",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-dimmer-12/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 750,
        "y": 380,
        "wires": [
            [
                "6af1216eb7c5c03f"
            ]
        ]
    },
    {
        "id": "d2f287de8e2b7bdb",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Yard",
        "lightcolor": false,
        "brightnesscontrol": true,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": true,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Outside",
        "name": "11. outside - yard",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-dimmer-11/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 750,
        "y": 440,
        "wires": [
            [
                "6af1216eb7c5c03f"
            ]
        ]
    },
    {
        "id": "b7b0b4d5c552d29a",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Light",
        "lightcolor": false,
        "brightnesscontrol": true,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": true,
        "passthru": false,
        "errorifstateunchaged": true,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Bedroom",
        "name": "2. big bedroom",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-dimmer-2/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1140,
        "y": 200,
        "wires": [
            [
                "769bb33f49f1c02b"
            ]
        ]
    },
    {
        "id": "645b5b8f07f055fc",
        "type": "noraf-openclose",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Shutters",
        "roomhint": "Bedroom",
        "name": "3. big bedroom",
        "directions": "",
        "openclosetype": "SHUTTER",
        "passthru": false,
        "errorifstateunchaged": false,
        "discrete": false,
        "lockunlock": false,
        "commandonly": false,
        "queryonly": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-blinds-3/state",
        "openvalue": "true",
        "openvalueType": "bool",
        "closevalue": "false",
        "closevalueType": "bool",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 740,
        "y": 840,
        "wires": [
            [
                "c78bcabe4f6f913b"
            ]
        ]
    },
    {
        "id": "8ad4a13f3069f1ac",
        "type": "function",
        "z": "7d41aab9fd0b6a3e",
        "name": "blinds.out",
        "func": "return {\n    payload: {\n        openPercent: msg.payload.open,\n    },\n    topic: msg.topic,\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 320,
        "wires": [
            [
                "43ff6ea09782443a"
            ]
        ]
    },
    {
        "id": "b18a911a13f74c55",
        "type": "function",
        "z": "7d41aab9fd0b6a3e",
        "name": "dimmers.in",
        "func": "if (msg.topic.startsWith('ha-switch/switch-dimmer-'))\n    return msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 170,
        "y": 240,
        "wires": [
            [
                "8775f81eb190b655"
            ]
        ]
    },
    {
        "id": "821e92a25e3b217f",
        "type": "function",
        "z": "7d41aab9fd0b6a3e",
        "name": "blinds.in",
        "func": "if (msg.topic.startsWith('ha-switch/switch-blinds-')) {\n    return {\n        payload: {\n            open: msg.payload.openPercent,\n            online: msg.payload.online,\n        },\n        topic: msg.topic,\n    };\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 160,
        "y": 320,
        "wires": [
            [
                "99f8a5fa2751fc29"
            ]
        ]
    },
    {
        "id": "dc8db494b158e485",
        "type": "noraf-openclose",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Shutters",
        "roomhint": "Office",
        "name": "5. office",
        "directions": "",
        "openclosetype": "SHUTTER",
        "passthru": false,
        "errorifstateunchaged": false,
        "discrete": false,
        "lockunlock": false,
        "commandonly": false,
        "queryonly": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-blinds-5/state",
        "openvalue": "true",
        "openvalueType": "bool",
        "closevalue": "false",
        "closevalueType": "bool",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 720,
        "y": 900,
        "wires": [
            [
                "c78bcabe4f6f913b"
            ]
        ]
    },
    {
        "id": "917568c1def8a578",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "d": true,
        "devicename": "Light",
        "lightcolor": false,
        "brightnesscontrol": true,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": true,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Office",
        "name": "8. office",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-dimmer-8/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1120,
        "y": 320,
        "wires": [
            [
                "769bb33f49f1c02b"
            ]
        ]
    },
    {
        "id": "0450c2ce91a72b78",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "TV Light",
        "lightcolor": false,
        "brightnesscontrol": true,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": true,
        "passthru": false,
        "errorifstateunchaged": true,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Living Room",
        "name": "4. living - main",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-dimmer-4/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 740,
        "y": 320,
        "wires": [
            [
                "6af1216eb7c5c03f"
            ]
        ]
    },
    {
        "id": "dfc52bfc266069f0",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Light",
        "lightcolor": false,
        "brightnesscontrol": true,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": true,
        "passthru": false,
        "errorifstateunchaged": true,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Kitchen",
        "name": "7. kitchen",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-dimmer-7/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1120,
        "y": 380,
        "wires": [
            [
                "769bb33f49f1c02b"
            ]
        ]
    },
    {
        "id": "7426cbb773e5162c",
        "type": "noraf-openclose",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Door Shutters",
        "roomhint": "Living Room",
        "name": "4. living - door",
        "directions": "",
        "openclosetype": "SHUTTER",
        "passthru": false,
        "errorifstateunchaged": false,
        "discrete": false,
        "lockunlock": false,
        "commandonly": false,
        "queryonly": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-blinds-4/state",
        "openvalue": "true",
        "openvalueType": "bool",
        "closevalue": "false",
        "closevalueType": "bool",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 740,
        "y": 960,
        "wires": [
            [
                "c78bcabe4f6f913b"
            ]
        ]
    },
    {
        "id": "efac8720a10238d0",
        "type": "noraf-openclose",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Window Shutters",
        "roomhint": "Living Room",
        "name": "6. living - window",
        "directions": "",
        "openclosetype": "SHUTTER",
        "passthru": false,
        "errorifstateunchaged": false,
        "discrete": false,
        "lockunlock": false,
        "commandonly": false,
        "queryonly": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-blinds-6/state",
        "openvalue": "true",
        "openvalueType": "bool",
        "closevalue": "false",
        "closevalueType": "bool",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1150,
        "y": 780,
        "wires": [
            [
                "dcf06f55dca5f699"
            ]
        ]
    },
    {
        "id": "6b14f65c73a0bf69",
        "type": "noraf-openclose",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Shutters",
        "roomhint": "Kitchen",
        "name": "2. kitchen window",
        "directions": "",
        "openclosetype": "SHUTTER",
        "passthru": false,
        "errorifstateunchaged": false,
        "discrete": false,
        "lockunlock": false,
        "commandonly": false,
        "queryonly": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-blinds-2/state",
        "openvalue": "true",
        "openvalueType": "bool",
        "closevalue": "false",
        "closevalueType": "bool",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1150,
        "y": 840,
        "wires": [
            [
                "dcf06f55dca5f699"
            ]
        ]
    },
    {
        "id": "ba592d172f57dd43",
        "type": "noraf-openclose",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Fixed Shutters",
        "roomhint": "Kitchen",
        "name": "8. kitchen - fixed window",
        "directions": "",
        "openclosetype": "SHUTTER",
        "passthru": false,
        "errorifstateunchaged": false,
        "discrete": false,
        "lockunlock": false,
        "commandonly": false,
        "queryonly": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-blinds-8/state",
        "openvalue": "true",
        "openvalueType": "bool",
        "closevalue": "false",
        "closevalueType": "bool",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1170,
        "y": 900,
        "wires": [
            [
                "dcf06f55dca5f699"
            ]
        ]
    },
    {
        "id": "6762d86fa674744b",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Light",
        "lightcolor": false,
        "brightnesscontrol": true,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": true,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Bathroom",
        "name": "5. big bedroom bathroom",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-dimmer-5/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1170,
        "y": 260,
        "wires": [
            [
                "769bb33f49f1c02b"
            ]
        ]
    },
    {
        "id": "340c4ef4bedec8a6",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "state changed",
        "mode": "link",
        "links": [
            "1b4bb0df8c93cc89",
            "3fdd728b0585df23",
            "b3a359bc7a838527",
            "b8a5316364ec5fe8"
        ],
        "x": 905,
        "y": 60,
        "wires": []
    },
    {
        "id": "dcb6e3571adc03a9",
        "type": "mqtt in",
        "z": "7d41aab9fd0b6a3e",
        "name": "",
        "topic": "ha-switch/+/state",
        "qos": "0",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 580,
        "y": 60,
        "wires": [
            [
                "cb6ee814173dbfcd"
            ]
        ]
    },
    {
        "id": "756f250b09605648",
        "type": "mqtt in",
        "z": "7d41aab9fd0b6a3e",
        "name": "",
        "topic": "ha-switch/+/online",
        "qos": "0",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 590,
        "y": 120,
        "wires": [
            [
                "a0e19251ca4aaac4"
            ]
        ]
    },
    {
        "id": "a0e19251ca4aaac4",
        "type": "function",
        "z": "7d41aab9fd0b6a3e",
        "name": "set online",
        "func": "if (typeof msg.payload !== 'boolean') {\n    return;\n}\n\nconst parts = msg.topic.split('/');\nparts[parts.length - 1] = 'state';\n\nreturn {\n    payload: {\n        online: msg.payload,\n    },\n    topic: parts.join('/'),\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 120,
        "wires": [
            [
                "cb6ee814173dbfcd"
            ]
        ]
    },
    {
        "id": "d1bf6e5c3d819560",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "update state",
        "links": [
            "49583d9de218bf42",
            "43ff6ea09782443a",
            "bd1a7b07efa6d260"
        ],
        "x": 965,
        "y": 60,
        "wires": [
            [
                "f51b18a179ad290d"
            ]
        ]
    },
    {
        "id": "f51b18a179ad290d",
        "type": "function",
        "z": "7d41aab9fd0b6a3e",
        "name": "set state",
        "func": "return {\n    retain: true,\n    ...msg,\n    topic: `${msg.topic}/set`\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1060,
        "y": 60,
        "wires": [
            [
                "a3019ae0eb0a0e72"
            ]
        ]
    },
    {
        "id": "6af1216eb7c5c03f",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 1",
        "mode": "link",
        "links": [
            "6dda18477b42006d"
        ],
        "x": 905,
        "y": 200,
        "wires": []
    },
    {
        "id": "03e9def7ed68132d",
        "type": "function",
        "z": "7d41aab9fd0b6a3e",
        "name": "onoff.out",
        "func": "const m = /([^.]+)\\.(\\d+)/.exec(msg.topic);\nconst topic = m ? m[1] : msg.topic;\nconst index = m ? +m[2] : 0;\n\nconst on = [];\non[index] = msg.payload;\n\nreturn {\n    payload: {\n        on,\n    },\n    topic,\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 280,
        "wires": [
            [
                "43ff6ea09782443a"
            ]
        ]
    },
    {
        "id": "26e27a446f7b7444",
        "type": "function",
        "z": "7d41aab9fd0b6a3e",
        "name": "onoff.in",
        "func": "if (msg.topic.startsWith('ha-switch/switch-onoff-')) {\n\n    if (Array.isArray(msg.payload.on) && msg.payload.on.length > 1) {\n        //multiple states on switch\n        return [msg.payload.on.map((on, index) => ({\n            payload: {\n                ...msg.payload,\n                on,\n            },\n            topic: `${msg.topic}.${index}`\n        }))];\n    } else {\n        return {\n            payload: {\n                ...msg.payload,\n                on: msg.payload?.on?.[0] ?? msg.payload?.on,\n            },\n            topic: msg.topic,\n        };\n    }\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 160,
        "y": 280,
        "wires": [
            [
                "8093f83674525563"
            ]
        ]
    },
    {
        "id": "1b4bb0df8c93cc89",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "link in 3",
        "links": [
            "340c4ef4bedec8a6"
        ],
        "x": 45,
        "y": 200,
        "wires": [
            [
                "26e27a446f7b7444",
                "b18a911a13f74c55",
                "821e92a25e3b217f",
                "52cbf133f2f61326",
                "3e2d1afb89aa35ed"
            ]
        ]
    },
    {
        "id": "43ff6ea09782443a",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 3",
        "mode": "link",
        "links": [
            "d1bf6e5c3d819560"
        ],
        "x": 515,
        "y": 200,
        "wires": []
    },
    {
        "id": "1eeea8ddfe40852e",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Light",
        "lightcolor": false,
        "brightnesscontrol": false,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": false,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Washer Room",
        "name": "9. washer room",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-onoff-9/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 740,
        "y": 500,
        "wires": [
            [
                "23cf6c6f6605894d"
            ]
        ]
    },
    {
        "id": "144549cc6dc7cbe7",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "d": true,
        "devicename": "Light",
        "lightcolor": false,
        "brightnesscontrol": false,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": false,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Guest Bathroom",
        "name": "3. bathroom - guest",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-onoff-3/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 750,
        "y": 560,
        "wires": [
            [
                "23cf6c6f6605894d"
            ]
        ]
    },
    {
        "id": "8714fba0422dd9f9",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Light",
        "lightcolor": false,
        "brightnesscontrol": false,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": false,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Service Room",
        "name": "1. cam. tehnica",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-onoff-1/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 740,
        "y": 600,
        "wires": [
            [
                "23cf6c6f6605894d"
            ]
        ]
    },
    {
        "id": "b2a67d17df0195f8",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Light",
        "lightcolor": false,
        "brightnesscontrol": true,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": true,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Main Bathroom",
        "name": "9. main bathroom",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-dimmer-9/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1150,
        "y": 440,
        "wires": [
            [
                "769bb33f49f1c02b"
            ]
        ]
    },
    {
        "id": "31ccd8e9f0a2e09e",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Entrance",
        "lightcolor": false,
        "brightnesscontrol": true,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": true,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Hallway",
        "name": "10. hallway - entrance",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-dimmer-10/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 760,
        "y": 260,
        "wires": [
            [
                "6af1216eb7c5c03f"
            ]
        ]
    },
    {
        "id": "c78d7adf71b71c07",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Entrance",
        "lightcolor": false,
        "brightnesscontrol": false,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": false,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Outside",
        "name": "7. outside - entrance",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-onoff-7/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 760,
        "y": 660,
        "wires": [
            [
                "23cf6c6f6605894d"
            ]
        ]
    },
    {
        "id": "6ebdf6901c3c44a1",
        "type": "noraf-switch",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Water Pump",
        "roomhint": "Service Room",
        "name": "r1. water pump",
        "passthru": false,
        "errorifstateunchaged": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-onoff-r1/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "twofactor": "ack",
        "twofactorpin": "",
        "filter": true,
        "asyncCmd": false,
        "outputs": 1,
        "x": 740,
        "y": 720,
        "wires": [
            [
                "23cf6c6f6605894d"
            ]
        ]
    },
    {
        "id": "52cbf133f2f61326",
        "type": "function",
        "z": "7d41aab9fd0b6a3e",
        "name": "Clone On/Off",
        "func": "/**\n * @type Map<string, {topic:string, type:'onoff'|'offonly'}>\n */\nconst CTRL = new Map([\n    ['ha-switch/switch-dimmer-5/state', { topic: 'ha-switch/switch-onoff-4/state', type: 'onoff' }],\n    ['ha-switch/switch-dimmer-9/state', { topic: 'ha-switch/switch-onoff-6/state', type: 'onoff' }],\n    ['ha-switch/switch-onoff-5/state', { topic: 'ha-switch/switch-onoff-8/state', type: 'offonly' }],\n]);\n\nconst topic = msg.topic;\nconst to = CTRL.get(topic);\nif (!to) {\n    return;\n}\n\nlet on = msg.payload.on;\nif (Array.isArray(on) && on.length) {\n    on = on[0];\n}\nif (typeof on != 'boolean') {\n    return;\n}\n\nconst lastOn = context.get(topic);\nif (lastOn !== on) {\n    context.set(topic, on);\n\n    if (to.type === 'offonly' && on) {\n        return;\n    }\n\n    return {\n        topic: to.topic,\n        payload: {\n            on: [on],\n        },\n    };\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 200,
        "wires": [
            [
                "43ff6ea09782443a"
            ]
        ]
    },
    {
        "id": "177b7b13cf11baf0",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Light",
        "lightcolor": false,
        "brightnesscontrol": false,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": false,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Guest Room",
        "name": "2. bedroom - guest",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-onoff-2/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1150,
        "y": 500,
        "wires": [
            [
                "f90095c9a660a010"
            ]
        ]
    },
    {
        "id": "cfd8480b606b454e",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "d": true,
        "devicename": "Light",
        "lightcolor": false,
        "brightnesscontrol": false,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": false,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Dressing",
        "name": "5. dressing",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-onoff-5/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1130,
        "y": 560,
        "wires": [
            [
                "f90095c9a660a010"
            ]
        ]
    },
    {
        "id": "72228fcd02ae304f",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "d": true,
        "devicename": "Light",
        "lightcolor": false,
        "brightnesscontrol": false,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": false,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Dressing Mirror",
        "name": "8. dressing mirror",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-onoff-8/state",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1150,
        "y": 600,
        "wires": [
            [
                "f90095c9a660a010"
            ]
        ]
    },
    {
        "id": "a3dbdc255ebe8243",
        "type": "noraf-openclose",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Shutters",
        "roomhint": "Guest Room",
        "name": "1. guest room",
        "directions": "",
        "openclosetype": "SHUTTER",
        "passthru": false,
        "errorifstateunchaged": false,
        "discrete": false,
        "lockunlock": false,
        "commandonly": false,
        "queryonly": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-blinds-1/state",
        "openvalue": "true",
        "openvalueType": "bool",
        "closevalue": "false",
        "closevalueType": "bool",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 740,
        "y": 780,
        "wires": [
            [
                "c78bcabe4f6f913b"
            ]
        ]
    },
    {
        "id": "cb6ee814173dbfcd",
        "type": "function",
        "z": "7d41aab9fd0b6a3e",
        "name": "store state",
        "func": "const value = global.get(msg.topic) || { online: true };\n\nif (Array.isArray(msg.payload.on) && msg.payload.on.length === 1) {\n    msg.payload.on = msg.payload.on[0];\n}\n\nglobal.set(msg.topic, {\n    ...value,\n    ...msg.payload,\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 60,
        "wires": [
            [
                "340c4ef4bedec8a6"
            ]
        ]
    },
    {
        "id": "3013c47f8d5eef60",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Work",
        "lightcolor": false,
        "brightnesscontrol": false,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": false,
        "passthru": false,
        "errorifstateunchaged": true,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Garage",
        "name": "d1.0 - garage - work",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-onoff-d-1/state.0",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1160,
        "y": 640,
        "wires": [
            [
                "f90095c9a660a010"
            ]
        ]
    },
    {
        "id": "53e009712f4ba5db",
        "type": "noraf-light",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Door",
        "lightcolor": false,
        "brightnesscontrol": false,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": false,
        "passthru": false,
        "errorifstateunchaged": true,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Garage",
        "name": "d1.1 - garage - door",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-onoff-d-1/state.1",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 1160,
        "y": 700,
        "wires": [
            [
                "f90095c9a660a010"
            ]
        ]
    },
    {
        "id": "2c6fd4fdcf461e64",
        "type": "noraf-openclose",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Car Gate",
        "roomhint": "Outside",
        "name": "",
        "directions": "",
        "openclosetype": "GATE",
        "passthru": false,
        "errorifstateunchaged": false,
        "discrete": true,
        "lockunlock": false,
        "commandonly": true,
        "queryonly": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-car-gate/state",
        "openvalue": "true",
        "openvalueType": "bool",
        "closevalue": "false",
        "closevalueType": "bool",
        "twofactor": "ack",
        "twofactorpin": "",
        "filter": true,
        "x": 220,
        "y": 500,
        "wires": [
            [
                "6824adfe2ef43b30"
            ]
        ]
    },
    {
        "id": "4c24a422c018775f",
        "type": "noraf-openclose",
        "z": "7d41aab9fd0b6a3e",
        "d": true,
        "devicename": "Human Gate",
        "roomhint": "Outside",
        "name": "",
        "directions": "",
        "openclosetype": "GATE",
        "passthru": false,
        "errorifstateunchaged": false,
        "discrete": true,
        "lockunlock": false,
        "commandonly": true,
        "queryonly": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-human-gate/state",
        "openvalue": "true",
        "openvalueType": "bool",
        "closevalue": "false",
        "closevalueType": "bool",
        "twofactor": "ack",
        "twofactorpin": "",
        "filter": true,
        "x": 230,
        "y": 560,
        "wires": [
            [
                "6824adfe2ef43b30"
            ]
        ]
    },
    {
        "id": "b35d5cb5c64994be",
        "type": "trigger",
        "z": "7d41aab9fd0b6a3e",
        "name": "",
        "op1": "",
        "op2": "false",
        "op1type": "nul",
        "op2type": "bool",
        "duration": "5",
        "extend": true,
        "overrideDelay": false,
        "units": "s",
        "reset": "",
        "bytopic": "topic",
        "topic": "topic",
        "outputs": 1,
        "x": 420,
        "y": 400,
        "wires": [
            [
                "5eea34281d67c83b"
            ]
        ]
    },
    {
        "id": "8775f81eb190b655",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 9",
        "mode": "link",
        "links": [
            "3671ebcac6a33473",
            "f0c595fd2cbfab7e"
        ],
        "x": 275,
        "y": 240,
        "wires": []
    },
    {
        "id": "3671ebcac6a33473",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "link in 11",
        "links": [
            "8775f81eb190b655"
        ],
        "x": 575,
        "y": 200,
        "wires": [
            [
                "f648133e35429919",
                "8521a26270a7f5ed",
                "d2f287de8e2b7bdb",
                "0450c2ce91a72b78",
                "31ccd8e9f0a2e09e"
            ]
        ]
    },
    {
        "id": "f0c595fd2cbfab7e",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "link in 12",
        "links": [
            "8775f81eb190b655"
        ],
        "x": 985,
        "y": 200,
        "wires": [
            [
                "b7b0b4d5c552d29a",
                "6762d86fa674744b",
                "917568c1def8a578",
                "dfc52bfc266069f0",
                "b2a67d17df0195f8"
            ]
        ]
    },
    {
        "id": "769bb33f49f1c02b",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 10",
        "mode": "link",
        "links": [
            "6dda18477b42006d"
        ],
        "x": 1305,
        "y": 200,
        "wires": []
    },
    {
        "id": "8093f83674525563",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 11",
        "mode": "link",
        "links": [
            "6b2f234d07a39253",
            "69b6eafb0ccb804f"
        ],
        "x": 275,
        "y": 280,
        "wires": []
    },
    {
        "id": "6b2f234d07a39253",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "link in 13",
        "links": [
            "8093f83674525563"
        ],
        "x": 575,
        "y": 500,
        "wires": [
            [
                "1eeea8ddfe40852e",
                "144549cc6dc7cbe7",
                "8714fba0422dd9f9",
                "c78d7adf71b71c07",
                "6ebdf6901c3c44a1"
            ]
        ]
    },
    {
        "id": "69b6eafb0ccb804f",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "link in 14",
        "links": [
            "8093f83674525563"
        ],
        "x": 985,
        "y": 500,
        "wires": [
            [
                "177b7b13cf11baf0",
                "cfd8480b606b454e",
                "72228fcd02ae304f",
                "3013c47f8d5eef60",
                "53e009712f4ba5db"
            ]
        ]
    },
    {
        "id": "23cf6c6f6605894d",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 12",
        "mode": "link",
        "links": [
            "f3cec6f29b539695"
        ],
        "x": 905,
        "y": 500,
        "wires": []
    },
    {
        "id": "f3cec6f29b539695",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "link in 15",
        "links": [
            "23cf6c6f6605894d",
            "f90095c9a660a010"
        ],
        "x": 325,
        "y": 280,
        "wires": [
            [
                "03e9def7ed68132d"
            ]
        ]
    },
    {
        "id": "f90095c9a660a010",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 13",
        "mode": "link",
        "links": [
            "f3cec6f29b539695"
        ],
        "x": 1315,
        "y": 500,
        "wires": []
    },
    {
        "id": "c1e22f0be8354b42",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "link in 16",
        "links": [
            "99f8a5fa2751fc29"
        ],
        "x": 575,
        "y": 780,
        "wires": [
            [
                "645b5b8f07f055fc",
                "dc8db494b158e485",
                "7426cbb773e5162c",
                "a3dbdc255ebe8243"
            ]
        ]
    },
    {
        "id": "99f8a5fa2751fc29",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 14",
        "mode": "link",
        "links": [
            "c1e22f0be8354b42",
            "7103c86fddd0b4c4"
        ],
        "x": 275,
        "y": 320,
        "wires": []
    },
    {
        "id": "c78bcabe4f6f913b",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 15",
        "mode": "link",
        "links": [
            "acc065a79178bb58"
        ],
        "x": 915,
        "y": 780,
        "wires": []
    },
    {
        "id": "acc065a79178bb58",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "link in 17",
        "links": [
            "c78bcabe4f6f913b",
            "dcf06f55dca5f699"
        ],
        "x": 325,
        "y": 320,
        "wires": [
            [
                "8ad4a13f3069f1ac"
            ]
        ]
    },
    {
        "id": "7103c86fddd0b4c4",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "link in 18",
        "links": [
            "99f8a5fa2751fc29"
        ],
        "x": 985,
        "y": 780,
        "wires": [
            [
                "efac8720a10238d0",
                "6b14f65c73a0bf69",
                "ba592d172f57dd43"
            ]
        ]
    },
    {
        "id": "dcf06f55dca5f699",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 16",
        "mode": "link",
        "links": [
            "acc065a79178bb58"
        ],
        "x": 1315,
        "y": 780,
        "wires": []
    },
    {
        "id": "3e2d1afb89aa35ed",
        "type": "function",
        "z": "7d41aab9fd0b6a3e",
        "name": "gates.in",
        "func": "const regex = /^ha-switch\\/switch-.*(-gate|garage)\\/state$/\nif (regex.test(msg.topic)) {\n    return {\n        payload: {\n            online: msg.payload.online,\n        },\n        topic: msg.topic,\n    };\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 160,
        "y": 360,
        "wires": [
            [
                "cf7e8d5ba2601ea3"
            ]
        ]
    },
    {
        "id": "cf7e8d5ba2601ea3",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 23",
        "mode": "link",
        "links": [
            "dd3deb2b19626528"
        ],
        "x": 275,
        "y": 360,
        "wires": []
    },
    {
        "id": "dd3deb2b19626528",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "link in 22",
        "links": [
            "5eea34281d67c83b",
            "cf7e8d5ba2601ea3"
        ],
        "x": 95,
        "y": 500,
        "wires": [
            [
                "4c24a422c018775f",
                "2c6fd4fdcf461e64",
                "6b043e0c546a5e30"
            ]
        ]
    },
    {
        "id": "82a73fd14fe3431f",
        "type": "function",
        "z": "7d41aab9fd0b6a3e",
        "name": "gates.out",
        "func": "if (msg.payload) {\n    return {\n        payload: {\n            on: [true],\n            for: 2\n        },\n        topic: msg.topic,\n        retain: false,\n    };\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 360,
        "wires": [
            [
                "43ff6ea09782443a"
            ]
        ]
    },
    {
        "id": "6824adfe2ef43b30",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 24",
        "mode": "link",
        "links": [
            "d330cbbb1892d1c5"
        ],
        "x": 345,
        "y": 500,
        "wires": []
    },
    {
        "id": "d330cbbb1892d1c5",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "link in 23",
        "links": [
            "6824adfe2ef43b30"
        ],
        "x": 325,
        "y": 360,
        "wires": [
            [
                "82a73fd14fe3431f",
                "b35d5cb5c64994be"
            ]
        ]
    },
    {
        "id": "5eea34281d67c83b",
        "type": "link out",
        "z": "7d41aab9fd0b6a3e",
        "name": "link out 25",
        "mode": "link",
        "links": [
            "dd3deb2b19626528"
        ],
        "x": 515,
        "y": 400,
        "wires": []
    },
    {
        "id": "a3019ae0eb0a0e72",
        "type": "mqtt out",
        "z": "7d41aab9fd0b6a3e",
        "name": "mqtt",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 1190,
        "y": 60,
        "wires": []
    },
    {
        "id": "6dda18477b42006d",
        "type": "link in",
        "z": "7d41aab9fd0b6a3e",
        "name": "link in 24",
        "links": [
            "6af1216eb7c5c03f",
            "769bb33f49f1c02b"
        ],
        "x": 325,
        "y": 240,
        "wires": [
            [
                "43ff6ea09782443a"
            ]
        ]
    },
    {
        "id": "6b043e0c546a5e30",
        "type": "noraf-openclose",
        "z": "7d41aab9fd0b6a3e",
        "devicename": "Garage",
        "roomhint": "Garage",
        "name": "",
        "directions": "",
        "openclosetype": "DOOR",
        "passthru": false,
        "errorifstateunchaged": false,
        "discrete": true,
        "lockunlock": false,
        "commandonly": true,
        "queryonly": false,
        "nora": "f1e538c1.0315f8",
        "topic": "ha-switch/switch-garage/state",
        "openvalue": "true",
        "openvalueType": "bool",
        "closevalue": "false",
        "closevalueType": "bool",
        "twofactor": "ack",
        "twofactorpin": "",
        "filter": true,
        "x": 220,
        "y": 620,
        "wires": [
            [
                "6824adfe2ef43b30"
            ]
        ]
    },
    {
        "id": "8755301a8c241477",
        "type": "mpp-input",
        "z": "d02cf25fa8114475",
        "name": "general",
        "mpp": "50383ae4cbb82921",
        "interval": "2",
        "timeout": "2",
        "query": "GeneralStatus",
        "x": 90,
        "y": 140,
        "wires": [
            [
                "ee29764d6322b235",
                "af672b4bd5a4f9eb",
                "9ae24bafaa9eeaae"
            ]
        ]
    },
    {
        "id": "0cb2bd44a8edc2d3",
        "type": "mpp-input",
        "z": "d02cf25fa8114475",
        "name": "power",
        "mpp": "50383ae4cbb82921",
        "interval": "2",
        "timeout": "2",
        "query": "PowerStatus",
        "x": 90,
        "y": 200,
        "wires": [
            [
                "151e85104313bf09",
                "4d5a91dbb440c2e4",
                "8012606b2ccfea72",
                "bce547419e98f9f9"
            ]
        ]
    },
    {
        "id": "658c70c17f292167",
        "type": "influxdb out",
        "z": "d02cf25fa8114475",
        "influxdb": "63bdbe3c09b491f2",
        "name": "db",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "home",
        "bucket": "power",
        "x": 390,
        "y": 120,
        "wires": []
    },
    {
        "id": "ee29764d6322b235",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "map",
        "func": "const batPower = (\n    msg.payload.battery.voltage *\n    msg.payload.battery.current / 1000).toFixed(1);\n\nnode.status({\n    fill: 'blue',\n    text: `bat: ${batPower} kW`,\n});\n\nreturn [[{\n    payload: msg.payload.acInput.voltage,\n    measurement: 'ac-input-voltage',\n}, {\n    payload: msg.payload.acInput.frequency,\n    measurement: 'ac-input-freq',\n}, {\n    payload: msg.payload.acOutput.voltage,\n    measurement: 'ac-output-voltage',\n}, {\n    payload: msg.payload.acOutput.frequency,\n    measurement: 'ac-output-freq',\n}, {\n    payload: {\n        voltage: msg.payload.battery.voltage,\n        current: msg.payload.battery.current,\n        capacity: msg.payload.battery.capacity,\n        power: msg.payload.battery.voltage *\n            msg.payload.battery.current,\n    },\n    measurement: 'battery',\n}, {\n    payload: {\n        voltage1: msg.payload.solarInput.voltage1,\n        voltage2: msg.payload.solarInput.voltage2,\n        current1: msg.payload.solarInput.current1,\n        current2: msg.payload.solarInput.current2,\n    },\n    measurement: 'solar-input',\n}]];",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 120,
        "wires": [
            [
                "658c70c17f292167"
            ]
        ]
    },
    {
        "id": "151e85104313bf09",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "map",
        "func": "const totalSolar = (\n    (msg.payload.solarInput.power1 +\n        msg.payload.solarInput.power2) / 1000).toFixed(1);\n\nconst totalgrid = (msg.payload.acInput.activePower.total / 1000).toFixed(1);\n\nconst totalOutput = (msg.payload.acOutput.activePower.total / 1000).toFixed(1);\n\nnode.status({\n    fill: \"blue\",\n    text: `solar: ${totalSolar} kW, grid: ${totalgrid} kW, out: ${totalOutput} kW`,\n});\n\nreturn [[{\n    payload: msg.payload.acInput.activePower,\n    measurement: 'ac-input-active-power',\n}, {\n    payload: msg.payload.acOutput.activePower,\n    measurement: 'ac-output-active-power',\n}, {\n    payload: msg.payload.acOutput.apparentPower,\n    measurement: 'ac-output-apparent-power',\n}, {\n    payload: {\n        string1: msg.payload.solarInput.power1,\n        string2: msg.payload.solarInput.power2,\n        total: msg.payload.solarInput.power1 +\n            msg.payload.solarInput.power2,\n    },\n    measurement: 'solar-input-power',\n}]];",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 220,
        "wires": [
            [
                "658c70c17f292167"
            ]
        ]
    },
    {
        "id": "002fbcc4b5600960",
        "type": "noraf-notify",
        "z": "d02cf25fa8114475",
        "tag": "",
        "title": "",
        "body": "",
        "icon": "",
        "name": "notify",
        "nora": "f1e538c1.0315f8",
        "topic": "",
        "actions": [],
        "closeNotification": false,
        "x": 830,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "8012606b2ccfea72",
        "type": "trigger",
        "z": "d02cf25fa8114475",
        "name": "",
        "op1": "true",
        "op2": "false",
        "op1type": "bool",
        "op2type": "bool",
        "duration": "5",
        "extend": true,
        "overrideDelay": false,
        "units": "s",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 260,
        "y": 320,
        "wires": [
            [
                "3fa4c0f648cfb1d0"
            ]
        ]
    },
    {
        "id": "3fa4c0f648cfb1d0",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "notify inv. connection",
        "func": "const status = msg.payload ? 'restored' : 'lost';\nconst at = new Date().toLocaleString();\nlet afterText = '';\nif (!msg.payload) {\n    context.set('lost_at', new Date().getTime());\n} else {\n    let after = new Date().getTime() - context.get('lost_at');\n    let unit = 'sec';\n    after /= 1000;\n    if (after > 60) {\n        after /= 60;\n        unit = 'min';\n    }\n    if (after > 60) {\n        after /= 60;\n        unit = 'hour';\n    }\n    afterText = `, after ${after.toFixed(1)} ${unit}`\n}\n\nreturn {\n    payload: {\n        tag: \"inverter-connection\",\n        title: \"Inverter connection\",\n        body: `Inverter connection ${status} at ${at}${afterText}`,\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 320,
        "wires": [
            [
                "002fbcc4b5600960"
            ]
        ]
    },
    {
        "id": "af672b4bd5a4f9eb",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "battery capacity",
        "func": "/** @type {number} */\nconst capacity = msg.payload.battery.capacity;\n\n/** @type {number[]} */\nconst values = this.past_values ?? [];\nvalues.splice(500);\nvalues.splice(0, 0, capacity);\nthis.past_values = values;\n\nlet average = values.reduce((a, b) => a + b, 0) / values.length;\naverage = Math.round(average);\n\nnode.status({ fill: \"blue\", shape: \"ring\", text: `${average}%` });\n\nreturn { payload: average };",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 60,
        "wires": [
            [
                "0bd6c3dd2661024f"
            ]
        ]
    },
    {
        "id": "4d5a91dbb440c2e4",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "set flow.batteryStatus",
        "func": "const lastValue = flow.get('batteryStatus');\nconst newValue = msg.payload.status.batteryPowerDirectionStatus;\nif (newValue !== lastValue) {\n    flow.set('batteryStatus', newValue);\n    return msg;\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 280,
        "wires": [
            [
                "6a88550f5db42499"
            ]
        ]
    },
    {
        "id": "c33b744470cd791e",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "46510dc1aab73a6d",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "voltage",
        "format": "{{msg.payload}}V",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 520,
        "y": 540,
        "wires": []
    },
    {
        "id": "24afa043bf723afc",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "general status map",
        "func": "return [{\n    payload: msg.payload.battery.voltage,\n}, {\n    payload: msg.payload.battery.current,\n}, {\n    payload: Math.round(msg.payload.battery.voltage *\n        msg.payload.battery.current),\n}, {\n    payload: {\n        ...msg.payload.acInput.voltage,\n        power: flow.get('acInputActivePowerTotal'),\n    }\n}];",
        "outputs": 4,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 190,
        "y": 600,
        "wires": [
            [
                "2f2071693f65b26f"
            ],
            [
                "c7cec8e32c79c714"
            ],
            [
                "a2e7d47846b5bf73"
            ],
            [
                "4d3dcc377b7c001d"
            ]
        ]
    },
    {
        "id": "8210f017aea4b421",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "46510dc1aab73a6d",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "capacity",
        "format": "{{msg.payload}}%",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 1080,
        "y": 60,
        "wires": []
    },
    {
        "id": "5859a7534d8c2bc7",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "46510dc1aab73a6d",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "current",
        "format": "{{msg.payload}}A",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 520,
        "y": 580,
        "wires": []
    },
    {
        "id": "f24c77b337c9beec",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "power status map",
        "func": "flow.set('acInputActivePowerTotal', msg.payload.acInput.activePower.total);\n\nreturn [{\n    payload: msg.payload.acOutput.activePower,\n}, {\n    payload: msg.payload.acOutput.apparentPower,\n}, {\n    payload: {\n        ...msg.payload.solarInput,\n        total:\n            msg.payload.solarInput.power1 +\n            msg.payload.solarInput.power2,\n    }\n}, {\n    payload: msg.payload.status.batteryPowerDirectionStatus,\n}, {\n    payload: msg.payload.status.dcAcPowerDirectionStatus,\n}];",
        "outputs": 5,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 190,
        "y": 780,
        "wires": [
            [
                "9c8be8156083c62a"
            ],
            [
                "f3fbc4587ffb1dbf"
            ],
            [
                "03f61c58a6769eb7"
            ],
            [
                "70a773574704da90"
            ],
            [
                "f48d394b166f1ddc"
            ]
        ]
    },
    {
        "id": "51ed10398534bbd0",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "46510dc1aab73a6d",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "status",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 510,
        "y": 820,
        "wires": []
    },
    {
        "id": "a3dbf718734f629d",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "46510dc1aab73a6d",
        "order": 0,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "conversion",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 530,
        "y": 860,
        "wires": []
    },
    {
        "id": "9ae24bafaa9eeaae",
        "type": "link out",
        "z": "d02cf25fa8114475",
        "name": "inverter general status",
        "mode": "link",
        "links": [
            "0120f22e197cc1f6",
            "4893dd7930bbba57"
        ],
        "x": 215,
        "y": 180,
        "wires": []
    },
    {
        "id": "4893dd7930bbba57",
        "type": "link in",
        "z": "d02cf25fa8114475",
        "name": "link in 27",
        "links": [
            "9ae24bafaa9eeaae"
        ],
        "x": 55,
        "y": 600,
        "wires": [
            [
                "24afa043bf723afc"
            ]
        ]
    },
    {
        "id": "bce547419e98f9f9",
        "type": "link out",
        "z": "d02cf25fa8114475",
        "name": "inverter power status",
        "mode": "link",
        "links": [
            "0120f22e197cc1f6",
            "600938fcf232ad14"
        ],
        "x": 285,
        "y": 180,
        "wires": []
    },
    {
        "id": "600938fcf232ad14",
        "type": "link in",
        "z": "d02cf25fa8114475",
        "name": "link in 28",
        "links": [
            "bce547419e98f9f9"
        ],
        "x": 65,
        "y": 780,
        "wires": [
            [
                "f24c77b337c9beec"
            ]
        ]
    },
    {
        "id": "ab4dc7b5b81d9d5b",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "9d1871108d73a07a",
        "order": 3,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "battery",
        "format": "{{msg.payload}}W",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 510,
        "y": 620,
        "wires": []
    },
    {
        "id": "a2faba3606b844a1",
        "type": "mqtt out",
        "z": "d02cf25fa8114475",
        "name": "",
        "topic": "sw-grid/command/switch:0",
        "qos": "1",
        "retain": "true",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 400,
        "y": 380,
        "wires": []
    },
    {
        "id": "19c4cab01dd6b937",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "connect grid?",
        "func": "const isGridConnected = flow.get('gridConnected') ?? false;\n\nlet batteryCurrent = context.get('batteryCurrent');\nlet batteryVoltage = context.get('batteryVoltage');\nlet solarPower = context.get('solarPower');\n/** @type {'auto'|'connect'|'disconnect'} */\nlet gridConnect = flow.get('gridConnect') ?? 'auto';\nconst batteryCapacity = global.get('batteryCapacity');\n\nif (typeof msg.payload?.battery?.current === 'number') {\n    const currentBatteryCurrent = msg.payload.battery.current;\n    if (currentBatteryCurrent !== batteryCurrent) {\n        context.set('batteryCurrent', batteryCurrent = currentBatteryCurrent);\n    }\n}\n\nif (typeof msg.payload?.battery?.voltage === 'number') {\n    const currentBatteryVoltage = msg.payload.battery.voltage;\n    if (currentBatteryVoltage !== batteryVoltage) {\n        context.set('batteryVoltage', batteryVoltage = currentBatteryVoltage);\n    }\n}\n\nif (typeof msg.payload?.solarInput?.power1 === 'number') {\n    const currentSolarPower = msg.payload.solarInput.power1 + msg.payload.solarInput.power2;\n    if (currentSolarPower !== solarPower) {\n        context.set('solarPower', solarPower = currentSolarPower);\n    }\n}\n\nif (typeof batteryCurrent !== 'number' ||\n    typeof batteryCapacity !== 'number' ||\n    typeof solarPower !== 'number' ||\n    typeof batteryVoltage !== 'number') {\n    return;\n}\n\nlet shouldConnectGrid;\n\nif (gridConnect === 'auto') {\n    if (!isGridConnected) {\n        shouldConnectGrid = batteryVoltage < 48;\n    } else {\n        const shouldDisconnectGrid =\n            (solarPower > 5000 || batteryCurrent > 50) && batteryCapacity > 40 ||\n            batteryCapacity >= 70;\n\n        shouldConnectGrid = !shouldDisconnectGrid;\n    }\n} else {\n    shouldConnectGrid = gridConnect === 'connect';\n}\n\nnode.status({\n    fill: shouldConnectGrid ? 'blue' : 'yellow',\n    text: `${shouldConnectGrid ? 'yes' : 'nope'} - ${gridConnect === 'auto' ? 'auto' : 'manual'}`,\n});\n\nif (shouldConnectGrid !== isGridConnected) {\n    const at = new Date().toLocaleString();\n    flow.set('gridConnected', shouldConnectGrid);\n    return [\n        {\n            payload: shouldConnectGrid ? 'on' : 'off'\n        },\n        {\n            payload: {\n                tag: \"grid-connection\",\n                title: \"Grid connection\",\n                body: `Grid ${shouldConnectGrid ? 'connected' : 'disconnected'} ${gridConnect === 'auto' ? '' : '(manual)'}, at ${at}`,\n            }\n        }\n    ];\n}\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 180,
        "y": 380,
        "wires": [
            [
                "a2faba3606b844a1",
                "d46c8723cce1eada"
            ],
            [
                "b02f923aa1eacf92"
            ]
        ]
    },
    {
        "id": "0120f22e197cc1f6",
        "type": "link in",
        "z": "d02cf25fa8114475",
        "name": "link in 32",
        "links": [
            "679b0cb9b118d7dd",
            "bce547419e98f9f9",
            "9ae24bafaa9eeaae",
            "b56557da9e0d3fdb"
        ],
        "x": 55,
        "y": 380,
        "wires": [
            [
                "19c4cab01dd6b937"
            ]
        ]
    },
    {
        "id": "b02f923aa1eacf92",
        "type": "noraf-notify",
        "z": "d02cf25fa8114475",
        "tag": "",
        "title": "",
        "body": "",
        "icon": "",
        "name": "notify",
        "nora": "f1e538c1.0315f8",
        "topic": "",
        "actions": [],
        "closeNotification": false,
        "x": 330,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "2f2071693f65b26f",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 390,
        "y": 540,
        "wires": [
            [
                "c33b744470cd791e"
            ]
        ]
    },
    {
        "id": "c7cec8e32c79c714",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 390,
        "y": 580,
        "wires": [
            [
                "5859a7534d8c2bc7"
            ]
        ]
    },
    {
        "id": "a2e7d47846b5bf73",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 390,
        "y": 620,
        "wires": [
            [
                "ab4dc7b5b81d9d5b"
            ]
        ]
    },
    {
        "id": "9c8be8156083c62a",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 390,
        "y": 700,
        "wires": [
            [
                "7ae3194535ef82de"
            ]
        ]
    },
    {
        "id": "03f61c58a6769eb7",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 390,
        "y": 780,
        "wires": [
            [
                "30b984a02c902ba5"
            ]
        ]
    },
    {
        "id": "70a773574704da90",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 390,
        "y": 820,
        "wires": [
            [
                "51ed10398534bbd0"
            ]
        ]
    },
    {
        "id": "f48d394b166f1ddc",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 390,
        "y": 860,
        "wires": [
            [
                "a3dbf718734f629d"
            ]
        ]
    },
    {
        "id": "0bd6c3dd2661024f",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 430,
        "y": 60,
        "wires": [
            [
                "ea85b483fb877384"
            ]
        ]
    },
    {
        "id": "f3fbc4587ffb1dbf",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 390,
        "y": 740,
        "wires": [
            [
                "7acf5f85598ea960"
            ]
        ]
    },
    {
        "id": "7ae3194535ef82de",
        "type": "ui_template",
        "z": "d02cf25fa8114475",
        "group": "9d1871108d73a07a",
        "name": "output (active)",
        "order": 4,
        "width": "6",
        "height": "1",
        "format": "<div class=\"nr-dashboard-text\" style=\"display: flex; flex-direction: column; padding: 0 10px 0 6px; margin: -10px 0;\">\n    <div style=\"display: flex; justify-content: space-between;\">\n        <p class=\"label\">output (active)</p>\n        <p class=\"value\">{{msg.payload.total}}W</p>\n    </div>\n    <div style=\"display: flex; justify-content: space-between; font-size: .9em; font-weight: 500\">\n        <p>(R) {{msg.payload.R}}W</p>\n        <p>(S) {{msg.payload.S}}W</p>\n        <p>(T) {{msg.payload.T}}W</p>\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 540,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "7acf5f85598ea960",
        "type": "ui_template",
        "z": "d02cf25fa8114475",
        "group": "9d1871108d73a07a",
        "name": "output (apparent)",
        "order": 5,
        "width": "6",
        "height": "1",
        "format": "<div class=\"nr-dashboard-text\" style=\"display: flex; flex-direction: column; padding: 0 10px 0 6px; margin: -10px 0;\">\n    <div style=\"display: flex; justify-content: space-between;\">\n        <p class=\"label\">output (apparent)</p>\n        <p class=\"value\">{{msg.payload.total}}VA</p>\n    </div>\n    <div style=\"display: flex; justify-content: space-between; font-size: .9em; font-weight: 500\">\n        <p>(R) {{msg.payload.R}}VA</p>\n        <p>(S) {{msg.payload.S}}VA</p>\n        <p>(T) {{msg.payload.T}}VA</p>\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 550,
        "y": 740,
        "wires": [
            []
        ]
    },
    {
        "id": "30b984a02c902ba5",
        "type": "ui_template",
        "z": "d02cf25fa8114475",
        "group": "9d1871108d73a07a",
        "name": "solar input",
        "order": 6,
        "width": "6",
        "height": "1",
        "format": "<div class=\"nr-dashboard-text\" style=\"display: flex; flex-direction: column; padding: 0 10px 0 6px; margin: -10px 0;\">\n    <div style=\"display: flex; justify-content: space-between;\">\n        <p class=\"label\">solar input</p>\n        <p class=\"value\">{{msg.payload.total}}W</p>\n    </div>\n    <div style=\"display: flex; justify-content: space-between; font-size: .9em; font-weight: 500\">\n        <p>(1) {{msg.payload.power1}}W</p>\n        <p>(2) {{msg.payload.power2}}W</p>\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 530,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "ea85b483fb877384",
        "type": "change",
        "z": "d02cf25fa8114475",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "batteryCapacity",
                "pt": "global",
                "to": "payload",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 610,
        "y": 60,
        "wires": [
            [
                "ea97108d7c286c24"
            ]
        ]
    },
    {
        "id": "a363becba48402b2",
        "type": "mqtt in",
        "z": "d02cf25fa8114475",
        "name": "",
        "topic": "sw-grid/online",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 610,
        "y": 380,
        "wires": [
            [
                "291bdf656757a188"
            ]
        ]
    },
    {
        "id": "291bdf656757a188",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "map",
        "func": "const isOnline = msg.payload;\nconst status = isOnline ? 'online' : 'offline';\nconst at = new Date().toLocaleString();\n\nnode.status({\n    fill: isOnline ? 'blue' : 'red',\n    text: isOnline ? 'online' : 'offline',\n});\n\nflow.set('gridOnline', isOnline);\n\nreturn {\n    payload: {\n        tag: \"grid-online\",\n        title: \"Grid\",\n        body: `Grid changed to ${status}, at ${at}`,\n        silent: true,\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 715,
        "y": 380,
        "wires": [
            [
                "002fbcc4b5600960",
                "d46c8723cce1eada"
            ]
        ],
        "l": false
    },
    {
        "id": "bb0a4494c7d35255",
        "type": "ui_dropdown",
        "z": "d02cf25fa8114475",
        "name": "",
        "label": "grid",
        "tooltip": "",
        "place": "Select option",
        "group": "827cf95cdf202cb4",
        "order": 2,
        "width": 0,
        "height": 0,
        "passthru": false,
        "multiple": false,
        "options": [
            {
                "label": "auto",
                "value": "auto",
                "type": "str"
            },
            {
                "label": "connect",
                "value": "connect",
                "type": "str"
            },
            {
                "label": "disconnect",
                "value": "disconnect",
                "type": "str"
            }
        ],
        "payload": "",
        "topic": "topic",
        "topicType": "msg",
        "className": "",
        "x": 310,
        "y": 500,
        "wires": [
            [
                "f6253cb39a917b09"
            ]
        ]
    },
    {
        "id": "f6253cb39a917b09",
        "type": "change",
        "z": "d02cf25fa8114475",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "gridConnect",
                "pt": "flow",
                "to": "payload",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 480,
        "y": 500,
        "wires": [
            [
                "b56557da9e0d3fdb"
            ]
        ]
    },
    {
        "id": "b56557da9e0d3fdb",
        "type": "link out",
        "z": "d02cf25fa8114475",
        "name": "_ grid connect mode",
        "mode": "link",
        "links": [
            "0120f22e197cc1f6"
        ],
        "x": 625,
        "y": 500,
        "wires": []
    },
    {
        "id": "252757374fa348f4",
        "type": "ui_template",
        "z": "d02cf25fa8114475",
        "group": "9d1871108d73a07a",
        "name": "grid",
        "order": 2,
        "width": "6",
        "height": "1",
        "format": "<div class=\"nr-dashboard-text\" style=\"display: flex; flex-direction: column; padding: 0 10px 0 6px; margin: -10px 0;\">\n    <div style=\"display: flex; justify-content: space-between;\">\n        <p class=\"label\">grid</p>\n        <p class=\"value\">{{msg.payload.power}}W</p>\n    </div>\n    <div style=\"display: flex; justify-content: space-between; font-size: .9em; font-weight: 500\">\n        <p>(R) {{msg.payload.R}}V</p>\n        <p>(S) {{msg.payload.S}}V</p>\n        <p>(T) {{msg.payload.T}}V</p>\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 510,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "860d818f14cd1779",
        "type": "noraf-charger",
        "z": "d02cf25fa8114475",
        "devicename": "Home Battery",
        "roomhint": "Service Room",
        "name": "",
        "passthru": false,
        "nora": "f1e538c1.0315f8",
        "isRechargeable": true,
        "queryOnlyEnergyStorage": true,
        "energyStorageDistanceUnitForUX": "KILOMETERS",
        "topic": "",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": false,
        "asyncCmd": false,
        "outputs": 1,
        "x": 720,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "8bb4278aca29cc84",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "map",
        "func": "const batteryCapacity = global.get('batteryCapacity');\n\nconst isCharging = flow.get('batteryStatus') === 'charge';\n\nconst capacityRemaining = [{\n    rawValue: batteryCapacity,\n    unit: 'PERCENTAGE',\n}];\n\nconst capacityUntilFull = [{\n    rawValue: 100 - batteryCapacity,\n    unit: 'PERCENTAGE',\n}];\n\nconst descriptiveCapacityRemaining = [\n    { threshold: 98, message: 'FULL' },\n    { threshold: 80, message: 'HIGH' },\n    { threshold: 40, message: 'MEDIUM' },\n    { threshold: 20, message: 'LOW' },\n    { threshold: 0, message: 'CRITICALLY_LOW' },\n]\n    .find(v => batteryCapacity >= v.threshold)\n    .message;\n\nreturn {\n    payload: {\n        capacityRemaining,\n        capacityUntilFull,\n        descriptiveCapacityRemaining,\n        isCharging,\n        isPluggedIn: true,\n    },\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 605,
        "y": 200,
        "wires": [
            [
                "860d818f14cd1779"
            ]
        ],
        "l": false
    },
    {
        "id": "4d3dcc377b7c001d",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": true,
        "property": "payload",
        "topi": "topic",
        "x": 390,
        "y": 660,
        "wires": [
            [
                "252757374fa348f4"
            ]
        ]
    },
    {
        "id": "93f27c194f1671e2",
        "type": "ui_chart",
        "z": "d02cf25fa8114475",
        "name": "last-year",
        "group": "ba44977d7b6ec35b",
        "order": 1,
        "width": "6",
        "height": "9",
        "label": "",
        "chartType": "horizontalBar",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "0",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#ff7b42",
            "#99c5ff",
            "#858dff",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 620,
        "y": 1000,
        "wires": [
            []
        ]
    },
    {
        "id": "dfaf723684262b45",
        "type": "influxdb in",
        "z": "d02cf25fa8114475",
        "influxdb": "63bdbe3c09b491f2",
        "name": "db",
        "query": "import \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Bucharest\")\n\nstart = date.truncate(t: -11mo, unit: 1mo)\nend = date.truncate(t: 1mo, unit: 1mo)\n\nfrom(bucket: \"power_aggregated\")\n    |> range(start: start, stop: end)\n    |> filter(\n        fn: (r) =>\n            r[\"_measurement\"] == \"ac-output-active-power\" or r[\"_measurement\"]\n                ==\n                \"ac-input-active-power\" or r[\"_measurement\"] == \"solar-input-power\",\n    )\n    |> aggregateWindow(\n        every: 1mo,\n        fn: (tables=<-, column) =>\n            tables\n                |> sum(column: \"_value\")\n    )\n    |> map(\n        fn: (r) =>\n            ({_measurement: r._measurement, _field: \"value\", _value: r._value, _time: date.sub(from: r._time, d: 1s)}),\n    )\n",
        "rawOutput": false,
        "precision": "",
        "retentionPolicy": "",
        "org": "home",
        "x": 310,
        "y": 1000,
        "wires": [
            [
                "7a7166818ad596c4"
            ]
        ]
    },
    {
        "id": "7a7166818ad596c4",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "map",
        "func": "/** @type {{_time:string,_value:number,_measurement:'ac-input-active-power'|'ac-output-active-power'|'solar-input-power'}[]} */\nconst data = msg.payload;\n\nconst months = [\n    \"Jan\", \"Feb\", \"Mar\",\n    \"Apr\", \"May\", \"Jun\",\n    \"Jul\", \"Aug\", \"Sep\",\n    \"Oct\", \"Nov\", \"Dec\"\n];\n\nconst mapped = data.map(v => {\n    const at = new Date(v._time);\n    const label = `${at.getFullYear()} - ${months[at.getMonth()]}`;\n    return {\n        label,\n        topic: v._measurement,\n        value: Math.round(v._value),\n        ticks: at.getTime(),\n    };\n});\n\n/** @type {Partial<Record<typeof mapped[0]['topic'], typeof mapped[0][]>>} */\nconst groups = {};\nmapped.forEach(v => {\n    let group = groups[v.topic];\n    if (!group) {\n        groups[v.topic] = group = [];\n    }\n    group.push(v);\n});\n\nObject.values(groups).forEach(v => {\n    v.sort((a, b) => a.ticks - b.ticks);\n});\n\nreturn {\n    payload: [{\n        \"series\": [\"Grid\", \"Used\"],\n        \"data\": [\n            groups['ac-input-active-power'].map(v => v.value),\n            groups['ac-output-active-power'].map(v => v.value),\n        ],\n        \"labels\": groups['ac-input-active-power'].map(v => v.label),\n    }]\n};\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 395,
        "y": 1000,
        "wires": [
            [
                "c0462038835605dd"
            ]
        ],
        "l": false
    },
    {
        "id": "99587ea33696a96e",
        "type": "influxdb in",
        "z": "d02cf25fa8114475",
        "influxdb": "63bdbe3c09b491f2",
        "name": "db",
        "query": "import \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Bucharest\")\n\nstart = date.truncate(t: -7d, unit: 1d)\nend = date.truncate(t: 1d, unit: 1d)\n\nfrom(bucket: \"power\")\n    |> range(start: start, stop: end)\n    |> filter(fn: (r) => r[\"_measurement\"] == \"solar-forecast\")\n    |> map(fn: (r) => ({r with _value: r._value / 1000.0}))\n    |> aggregateWindow(every: 1d, fn: sum)\n    |> map(\n        fn: (r) =>\n            ({\n                _measurement: r._measurement,\n                _field: \"value\",\n                _value: r._value,\n                _time: date.sub(from: r._time, d: 1s),\n            }),\n    )\n    |> yield(name: \"solar-forecast\")\n\nfrom(bucket: \"power_aggregated\")\n    |> range(start: start, stop: end)\n    |> filter(\n        fn: (r) =>\n            r[\"_measurement\"] == \"solar-input-power\" or r[\"_measurement\"]\n                ==\n                \"ac-output-active-power\" or r[\"_measurement\"] == \"ac-input-active-power\",\n    )\n    |> map(\n        fn: (r) =>\n            ({_measurement: r._measurement, _field: \"value\", _value: r._value, _time: r._time}),\n    )\n",
        "rawOutput": false,
        "precision": "",
        "retentionPolicy": "",
        "org": "home",
        "x": 310,
        "y": 960,
        "wires": [
            [
                "d6720e316ab6c1c1"
            ]
        ]
    },
    {
        "id": "a1a82b228246dd6f",
        "type": "inject",
        "z": "d02cf25fa8114475",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "300",
        "crontab": "",
        "once": true,
        "onceDelay": "5",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 130,
        "y": 920,
        "wires": [
            [
                "99587ea33696a96e",
                "dfaf723684262b45",
                "ec8ea9e4de28967c",
                "ad0eaeed7112a695",
                "208b4b347860a827",
                "4332a86f0a017a4e"
            ]
        ]
    },
    {
        "id": "d6720e316ab6c1c1",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "map",
        "func": "/** @type {{\n * _time:string,\n * _value:number,\n * _measurement:\n *  'solar-input-power'|\n *  'ac-input-active-power'|\n *  'ac-output-active-power'|\n *  'solar-forecast'\n * }[]} */\nconst data = msg.payload;\n\nconst days = [\n    \"Sun\", \"Mon\", \"Tue\",\n    \"Wed\", \"Thu\", \"Fri\", \"Sat\",\n];\n\nconst mapped = data.map(v => {\n    const at = new Date(v._time);\n    const label = days[at.getDay()];\n    return {\n        label,\n        topic: v._measurement,\n        value: Math.round(v._value * 10) / 10,\n        ticks: at.getTime(),\n    };\n});\n\n/** @type {Partial<Record<typeof mapped[0]['topic'], typeof mapped[0][]>>} */\nconst groups = {};\nmapped.forEach(v => {\n    let group = groups[v.topic];\n    if (!group) {\n        groups[v.topic] = group = [];\n    }\n    group.push(v);\n});\n\nObject.values(groups).forEach(v => {\n    v.sort((a, b) => a.ticks - b.ticks);\n});\n\nreturn {\n    payload: [{\n        \"series\": [\"Grid\", \"Used\", \"Solar\", \"Forecast\"],\n        \"data\": [\n            groups['ac-input-active-power'].map(v => v.value),\n            groups['ac-output-active-power'].map(v => v.value),\n            groups['solar-input-power'].map(v => v.value),\n            groups['solar-forecast'].map(v => v.value),\n        ],\n        \"labels\": groups['solar-forecast'].map(v => v.label),\n    }]\n};\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 395,
        "y": 960,
        "wires": [
            [
                "51966ac4cb525180"
            ]
        ],
        "l": false
    },
    {
        "id": "8e1f5d5ba29e2236",
        "type": "ui_chart",
        "z": "d02cf25fa8114475",
        "name": "last-week",
        "group": "3b7b403039fa5965",
        "order": 1,
        "width": "6",
        "height": "7",
        "label": "",
        "chartType": "horizontalBar",
        "legend": "false",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "0",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#ff7b42",
            "#99c5ff",
            "#73c990",
            "#e4e59a",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 620,
        "y": 960,
        "wires": [
            []
        ]
    },
    {
        "id": "c3798cd147f21703",
        "type": "ui_template",
        "z": "d02cf25fa8114475",
        "group": "827cf95cdf202cb4",
        "name": "",
        "order": 1,
        "width": 0,
        "height": 0,
        "format": "<style>\n    .nr-dashboard-chart-title {\n        display: none;\n    }\n\n    .nr-dashboard-dropdown>md-input-container {\n        padding-left: 12px;\n        padding-right: 12px;\n        margin: 0;\n        margin-right: 0;\n    }\n\n    .equal-space.nr-dashboard-dropdown p.label {\n        flex: 7;\n    }\n    .equal-space.nr-dashboard-dropdown md-select {\n        flex: 3 !important;\n    }\n</style>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "global",
        "className": "",
        "x": 860,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "ec8ea9e4de28967c",
        "type": "influxdb in",
        "z": "d02cf25fa8114475",
        "influxdb": "63bdbe3c09b491f2",
        "name": "db",
        "query": "import \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Bucharest\")\n\nstart = date.truncate(t: now(), unit: 1d)\nend = now()\nendForecast = date.truncate(t: 1d, unit: 1d)\n\nfrom(bucket: \"power\")\n    |> range(start: start, stop: endForecast)\n    |> filter(fn: (r) => r[\"_measurement\"] == \"solar-forecast\")\n    |> map(fn: (r) => ({r with _value: r._value / 1000.0}))\n    |> yield(name: \"solar-forecast\")\n\nfrom(bucket: \"power\")\n    |> range(start: start, stop: end)\n    |> filter(\n        fn: (r) =>\n            r[\"_measurement\"] == \"ac-output-active-power\" or \n            r[\"_measurement\"] == \"ac-input-active-power\" or \n            r[\"_measurement\"] == \"solar-input-power\"\n    )\n    |> filter(fn: (r) => r[\"_field\"] == \"total\" or r[\"_field\"] == \"value\")\n    |> aggregateWindow(\n        every: 1h,\n        fn: (tables=<-, column) =>\n            tables\n                |> integral(unit: 1h, column: \"_value\")\n                |> map(fn: (r) => ({r with _value: r._value / 1000.0})),\n    )\n    |> map(\n        fn: (r) =>\n            ({\n                _measurement: r._measurement,\n                _field: \"value\",\n                _value: r._value,\n                _time: r._time,\n            }),\n    )\n    |> yield(name: \"today\")\n\n",
        "rawOutput": false,
        "precision": "",
        "retentionPolicy": "",
        "org": "home",
        "x": 310,
        "y": 920,
        "wires": [
            [
                "d1fd58eb9690fc72"
            ]
        ]
    },
    {
        "id": "d1fd58eb9690fc72",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "map",
        "func": "/** @type {{\n * _time:string,\n * _value:number,\n * _measurement:\n *  'solar-input-power'|\n *  'ac-input-active-power'|\n *  'ac-output-active-power'|\n *  'solar-forecast'\n * }[]} */\nconst data = msg.payload;\n\nconst mapped = data.map(v => {\n    return {\n        topic: v._measurement,\n        value: Math.round(v._value * 10) / 10,\n        ticks: new Date(v._time).getTime(),\n    };\n});\n\n/** @type {Partial<Record<typeof mapped[0]['topic'], typeof mapped[0][]>>} */\nconst groups = {};\nmapped.forEach(v => {\n    let group = groups[v.topic];\n    if (!group) {\n        groups[v.topic] = group = [];\n    }\n    group.push(v);\n});\n\nObject.values(groups).forEach(v => {\n    v.sort((a, b) => a.ticks - b.ticks);\n});\n\nreturn {\n    payload: [{\n        \"series\": [\"Grid\", \"Solar\", \"Used\", \"Forecast\"],\n        \"data\": [\n            getData(groups['ac-input-active-power']),\n            getData(groups['solar-input-power']),\n            getData(groups['ac-output-active-power']),\n            getData(groups['solar-forecast'] ?? []),\n        ],\n    }]\n};\n\n/** @param data {{ticks: number, value: number}[]} */\nfunction getData(data) {\n    const mapped = [];\n    let lastDate;\n    for (const v of data) {\n        lastDate = v.ticks;\n        mapped.push({\n            x: v.ticks,\n            y: v.value,\n        });\n    }\n\n    if (lastDate) {\n        const l = new Date(lastDate)\n        l.setHours(23, 59, 59, 0);\n        mapped.push({\n            x: l.getTime(),\n            y: null,\n        });\n    }\n\n    return mapped;\n}\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 395,
        "y": 920,
        "wires": [
            [
                "a4f0f047b83a7ffa"
            ]
        ],
        "l": false
    },
    {
        "id": "f86d42f7967c6136",
        "type": "ui_chart",
        "z": "d02cf25fa8114475",
        "name": "today",
        "group": "b53a900ec325bc65",
        "order": 1,
        "width": "6",
        "height": "4",
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "0",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#ff7b42",
            "#73c990",
            "#99c5ff",
            "#e4e59a",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 610,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "a4f0f047b83a7ffa",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 490,
        "y": 920,
        "wires": [
            [
                "f86d42f7967c6136"
            ]
        ]
    },
    {
        "id": "51966ac4cb525180",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 490,
        "y": 960,
        "wires": [
            [
                "8e1f5d5ba29e2236"
            ]
        ]
    },
    {
        "id": "c0462038835605dd",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 490,
        "y": 1000,
        "wires": [
            [
                "93f27c194f1671e2"
            ]
        ]
    },
    {
        "id": "aaab93ca80d93467",
        "type": "influxdb in",
        "z": "d02cf25fa8114475",
        "influxdb": "63bdbe3c09b491f2",
        "name": "db",
        "query": "",
        "rawOutput": false,
        "precision": "",
        "retentionPolicy": "",
        "org": "home",
        "x": 310,
        "y": 1360,
        "wires": [
            [
                "253ee55b662add5a"
            ]
        ]
    },
    {
        "id": "253ee55b662add5a",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "map",
        "func": "/** @type {{\n * result: 'offset'|'today',\n * _time:string,\n * _value:number,\n * _measurement:'solar-input-power',\n * hour: number,\n * }[]} */\nconst data = msg.payload;\n\nconst offset = flow.get('dayOffset') ?? -1;\n\nconst mapped = data.map(v => {\n    const d = new Date(v._time);\n    return {\n        result: v.result,\n        x: d.getTime(),\n        y: Math.round(v._value * 10) / 10,\n    };\n});\n\nconst offsetData = mapped\n    .filter(v => v.result === 'offset')\n    .map(({ x, y }) => {\n        const d = new Date(x);\n        d.setDate(d.getDate() - offset);\n        return {\n            x: d.getTime(),\n            y,\n        };\n    });\nconst todayData = mapped\n    .filter(v => v.result === 'today')\n    .map(({ x, y }) => ({ x, y }));\n\nreturn {\n    payload: [{\n        \"series\": [\"Today\", `${offset} day`],\n        \"data\": [\n            todayData,\n            offsetData,\n        ],\n    }]\n};\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 395,
        "y": 1360,
        "wires": [
            [
                "c22d9b44d1d0ba74"
            ]
        ],
        "l": false
    },
    {
        "id": "9605e281fd324990",
        "type": "ui_chart",
        "z": "d02cf25fa8114475",
        "name": "today vs yesterday",
        "group": "73c9d7077dcee7d3",
        "order": 2,
        "width": "6",
        "height": "4",
        "label": "",
        "chartType": "line",
        "legend": "false",
        "xformat": "HH:mm",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "0",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": [
            "#73c990",
            "#ff7b42",
            "#858dff",
            "#2ca02c",
            "#98df8a",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 650,
        "y": 1360,
        "wires": [
            []
        ]
    },
    {
        "id": "c22d9b44d1d0ba74",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 490,
        "y": 1360,
        "wires": [
            [
                "9605e281fd324990"
            ]
        ]
    },
    {
        "id": "312d45a724aa1438",
        "type": "ui_numeric",
        "z": "d02cf25fa8114475",
        "name": "",
        "label": "offset (days)",
        "tooltip": "",
        "group": "73c9d7077dcee7d3",
        "order": 1,
        "width": 0,
        "height": 0,
        "wrap": false,
        "passthru": false,
        "topic": "topic",
        "topicType": "msg",
        "format": "{{value}} day",
        "min": "-100",
        "max": "-1",
        "step": 1,
        "className": "",
        "x": 290,
        "y": 1400,
        "wires": [
            [
                "9990b84a250ea4f7"
            ]
        ]
    },
    {
        "id": "e40ebc487598d34c",
        "type": "change",
        "z": "d02cf25fa8114475",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "dayOffset",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 730,
        "y": 1400,
        "wires": [
            [
                "ad0eaeed7112a695"
            ]
        ]
    },
    {
        "id": "ad0eaeed7112a695",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "map",
        "func": "const offset = flow.get('dayOffset') ?? -1;\nreturn {\n    query: `\nimport \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Bucharest\")\n\ngetSolarEnergyPerHour = (tables=<-) =>\n    tables\n        |> filter(fn: (r) => r[\"_measurement\"] == \"solar-input-power\")\n        |> filter(fn: (r) => r[\"_field\"] == \"total\")\n        |> aggregateWindow(\n            every: 1h,\n            fn: (tables=<-, column) =>\n                tables\n                    |> integral(unit: 1h, column: \"_value\")\n                    |> map(fn: (r) => ({r with _value: r._value / 1000.0})),\n        )\n        |> map(\n            fn: (r) =>\n                ({\n                    _measurement: r._measurement,\n                    _field: \"value\",\n                    _value: r._value,\n                    _time: r._time,\n                }),\n        )\n\nfrom(bucket: \"power\")\n    |> range(start: date.truncate(t: ${offset}d, unit: 1d), stop: date.truncate(t: ${offset + 1}d, unit: 1d))\n    |> getSolarEnergyPerHour()\n    |> yield(name: \"offset\")\n\nfrom(bucket: \"power\")\n    |> range(start: date.truncate(t: now(), unit: 1d), stop: now())\n    |> getSolarEnergyPerHour()\n    |> yield(name: \"today\")\n`\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 225,
        "y": 1360,
        "wires": [
            [
                "aaab93ca80d93467"
            ]
        ],
        "l": false
    },
    {
        "id": "9990b84a250ea4f7",
        "type": "trigger",
        "z": "d02cf25fa8114475",
        "name": "",
        "op1": "",
        "op2": "",
        "op1type": "nul",
        "op2type": "payl",
        "duration": "1",
        "extend": true,
        "overrideDelay": false,
        "units": "s",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 440,
        "y": 1400,
        "wires": [
            [
                "5eca1f0432cd01df"
            ]
        ]
    },
    {
        "id": "5eca1f0432cd01df",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 570,
        "y": 1400,
        "wires": [
            [
                "e40ebc487598d34c"
            ]
        ]
    },
    {
        "id": "208b4b347860a827",
        "type": "influxdb in",
        "z": "d02cf25fa8114475",
        "influxdb": "63bdbe3c09b491f2",
        "name": "db",
        "query": "from(bucket: \"power_aggregated\")\n    |> range(start: 2023-10-04T00:00:00Z, stop: 1d)\n    |> filter(\n        fn: (r) =>\n            r[\"_measurement\"] == \"ac-input-active-power\" or \n            r[\"_measurement\"] == \"ac-output-active-power\" or \n            r[\"_measurement\"] == \"solar-input-power\",\n    )\n    |> sum()\n    |> yield()\n",
        "rawOutput": false,
        "precision": "",
        "retentionPolicy": "",
        "org": "home",
        "x": 310,
        "y": 1100,
        "wires": [
            [
                "d8752a58d3ffc0a3"
            ]
        ]
    },
    {
        "id": "d8752a58d3ffc0a3",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "function 1",
        "func": "/** @type {{_value:number, _measurement:'ac-input-active-power'|'ac-output-active-power'|'solar-input-power'}[]} */\nconst measurements = msg.payload;\n\nconst totalIn = measurements\n    .find(v => v._measurement === 'ac-input-active-power')\n    ._value;\n\nconst totalOut = measurements\n    .find(v => v._measurement === 'ac-output-active-power')\n    ._value;\n\nconst solarInput = measurements\n    .find(v => v._measurement === 'solar-input-power')\n    ._value;\n\nreturn [{\n    payload: Math.round((totalOut - totalIn) / solarInput * 1000) / 10,\n}, {\n    payload: Math.round(totalOut * 10) / 10,\n}, {\n    payload: Math.round((totalOut - totalIn) * 10) / 10,\n}, {\n    payload: Math.round((totalOut - totalIn) / totalOut * 1000) / 10,\n}]",
        "outputs": 4,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 395,
        "y": 1100,
        "wires": [
            [
                "887f3ed6281437e5"
            ],
            [
                "2d3bf4a3e04379a7"
            ],
            [
                "2fea9c289254d63a"
            ],
            [
                "7ad3ec6fab9d4fb7"
            ]
        ],
        "l": false
    },
    {
        "id": "4332a86f0a017a4e",
        "type": "influxdb in",
        "z": "d02cf25fa8114475",
        "influxdb": "63bdbe3c09b491f2",
        "name": "db",
        "query": "import \"date\"\nimport \"timezone\"\n\noption location = timezone.location(name: \"Europe/Bucharest\")\n\nfrom(bucket: \"power_aggregated\")\n    |> range(start: -31d, stop: 1d)\n    |> filter(\n        fn: (r) =>\n            r[\"_measurement\"] == \"ac-input-active-power\" or \n            r[\"_measurement\"] == \"ac-output-active-power\" or \n            r[\"_measurement\"] == \"solar-input-power\",\n    )\n    |> sum()\n    |> yield()\n",
        "rawOutput": false,
        "precision": "",
        "retentionPolicy": "",
        "org": "home",
        "x": 310,
        "y": 1260,
        "wires": [
            [
                "62df97620fc39f4a"
            ]
        ]
    },
    {
        "id": "d6533ffbd477f895",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "1e8ff3e2e8219b0c",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "efficiency (all time)",
        "label": "efficiency",
        "format": "{{msg.payload}}%",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 650,
        "y": 1040,
        "wires": []
    },
    {
        "id": "b8f73de9b8242c6a",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "af294a26a01766cc",
        "order": 2,
        "width": 0,
        "height": 0,
        "name": "efficiency (-31 days)",
        "label": "efficiency",
        "format": "{{msg.payload}}%",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 660,
        "y": 1200,
        "wires": []
    },
    {
        "id": "887f3ed6281437e5",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 490,
        "y": 1040,
        "wires": [
            [
                "d6533ffbd477f895"
            ]
        ]
    },
    {
        "id": "1989ea913e42d2ba",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 490,
        "y": 1200,
        "wires": [
            [
                "b8f73de9b8242c6a"
            ]
        ]
    },
    {
        "id": "9a4aad9ff010f130",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "1e8ff3e2e8219b0c",
        "order": 2,
        "width": 0,
        "height": 0,
        "name": "used (all time)",
        "label": "used",
        "format": "{{msg.payload}} kWh",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 640,
        "y": 1080,
        "wires": []
    },
    {
        "id": "2d3bf4a3e04379a7",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 490,
        "y": 1080,
        "wires": [
            [
                "9a4aad9ff010f130"
            ]
        ]
    },
    {
        "id": "d78f0c756ab516b6",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "1e8ff3e2e8219b0c",
        "order": 3,
        "width": 0,
        "height": 0,
        "name": "from solar (all time)",
        "label": "from solar",
        "format": "{{msg.payload}} kWh",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 650,
        "y": 1120,
        "wires": []
    },
    {
        "id": "2fea9c289254d63a",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 490,
        "y": 1120,
        "wires": [
            [
                "d78f0c756ab516b6"
            ]
        ]
    },
    {
        "id": "434691015e70ce37",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "1e8ff3e2e8219b0c",
        "order": 4,
        "width": 0,
        "height": 0,
        "name": "from solar% (all time)",
        "label": "from solar",
        "format": "{{msg.payload}}%",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 660,
        "y": 1160,
        "wires": []
    },
    {
        "id": "7ad3ec6fab9d4fb7",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 490,
        "y": 1160,
        "wires": [
            [
                "434691015e70ce37"
            ]
        ]
    },
    {
        "id": "0f506b0b897273b0",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "9d1871108d73a07a",
        "order": 1,
        "width": 0,
        "height": 0,
        "name": "",
        "label": "grid status",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 910,
        "y": 440,
        "wires": []
    },
    {
        "id": "d46c8723cce1eada",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "function 3",
        "func": "const gridConnected = flow.get('gridConnected') ?? false;\nconst gridOnline = flow.get('gridOnline') ?? false;\n\nreturn {\n    payload: `${gridConnected ? 'connected' : 'disconnected'}/${gridOnline ? 'online' : 'offline'}`,\n};",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 795,
        "y": 440,
        "wires": [
            [
                "0f506b0b897273b0"
            ]
        ],
        "l": false
    },
    {
        "id": "63de766456058850",
        "type": "inject",
        "z": "d02cf25fa8114475",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "payload": "gridConnect",
        "payloadType": "flow",
        "x": 150,
        "y": 500,
        "wires": [
            [
                "bb0a4494c7d35255"
            ]
        ]
    },
    {
        "id": "1052568395e4a337",
        "type": "inject",
        "z": "d02cf25fa8114475",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "payload": "dayOffset",
        "payloadType": "flow",
        "x": 120,
        "y": 1400,
        "wires": [
            [
                "312d45a724aa1438"
            ]
        ]
    },
    {
        "id": "036a405f42237d92",
        "type": "http request",
        "z": "d02cf25fa8114475",
        "name": "",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://api.forecast.solar/estimate/45.9735/21.3192/18/0/15",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "accept",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 290,
        "y": 1460,
        "wires": [
            [
                "f941bd3e48b2e20f"
            ]
        ]
    },
    {
        "id": "1426b9765d3874a2",
        "type": "inject",
        "z": "d02cf25fa8114475",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "*/30 5-21 * * *",
        "once": false,
        "onceDelay": "10",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 130,
        "y": 1460,
        "wires": [
            [
                "036a405f42237d92"
            ]
        ]
    },
    {
        "id": "5c82cb86c2784c5c",
        "type": "influxdb out",
        "z": "d02cf25fa8114475",
        "influxdb": "63bdbe3c09b491f2",
        "name": "db",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "home",
        "bucket": "power",
        "x": 590,
        "y": 1480,
        "wires": []
    },
    {
        "id": "f941bd3e48b2e20f",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "map",
        "func": "if (msg.payload?.message?.type !== 'success') {\n    global.set('estimatedSolarProduction', 0);\n    node.status({ fill: \"red\", shape: \"ring\", text: \"error\" });\n    node.warn(msg);\n    return;\n}\n\nconst [todayDate] = new Date().toISOString().split('T');\n\n/** @type {Record<string, number>} */\nconst forecast = msg.payload.result.watt_hours_period;\n\nconst influxDbData = {\n    payload: [],\n    measurement: 'solar-forecast',\n};\n\nconst now = new Date().getTime();\n\nfor (const [key, value] of Object.entries(forecast)) {\n    const ticks = new Date(key).getTime();\n    if (ticks <= now) {\n        continue;\n    }\n\n    influxDbData.payload.push([\n        {\n            value,\n            time: ticks,\n        },\n        {} //tags\n    ]);\n}\n\nconst estimatedProduction = msg.payload.result.watt_hours_day[todayDate];\n\nglobal.set('estimatedSolarProduction', estimatedProduction);\nnode.status({\n    fill: \"blue\", shape: \"ring\",\n    text: `${estimatedProduction} kWh`\n});\n\nreturn [{\n    payload: estimatedProduction,\n}, influxDbData];",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 1460,
        "wires": [
            [],
            [
                "5c82cb86c2784c5c"
            ]
        ]
    },
    {
        "id": "ea97108d7c286c24",
        "type": "link out",
        "z": "d02cf25fa8114475",
        "name": "battery capacity",
        "mode": "link",
        "links": [
            "6f8b99e1a75e4eae",
            "81c5a79fcb978074"
        ],
        "x": 755,
        "y": 60,
        "wires": []
    },
    {
        "id": "6a88550f5db42499",
        "type": "link out",
        "z": "d02cf25fa8114475",
        "name": "battery status",
        "mode": "link",
        "links": [
            "81c5a79fcb978074"
        ],
        "x": 435,
        "y": 280,
        "wires": []
    },
    {
        "id": "81c5a79fcb978074",
        "type": "link in",
        "z": "d02cf25fa8114475",
        "name": "link in 36",
        "links": [
            "ea97108d7c286c24",
            "6a88550f5db42499"
        ],
        "x": 545,
        "y": 200,
        "wires": [
            [
                "8bb4278aca29cc84"
            ]
        ]
    },
    {
        "id": "6f8b99e1a75e4eae",
        "type": "link in",
        "z": "d02cf25fa8114475",
        "name": "link in 37",
        "links": [
            "ea97108d7c286c24"
        ],
        "x": 985,
        "y": 60,
        "wires": [
            [
                "8210f017aea4b421"
            ]
        ]
    },
    {
        "id": "62df97620fc39f4a",
        "type": "function",
        "z": "d02cf25fa8114475",
        "name": "function 7",
        "func": "/** @type {{_value:number, _measurement:'ac-input-active-power'|'ac-output-active-power'|'solar-input-power'}[]} */\nconst measurements = msg.payload;\n\nconst totalIn = measurements\n    .find(v => v._measurement === 'ac-input-active-power')\n    ._value;\n\nconst totalOut = measurements\n    .find(v => v._measurement === 'ac-output-active-power')\n    ._value;\n\nconst solarInput = measurements\n    .find(v => v._measurement === 'solar-input-power')\n    ._value;\n\nreturn [{\n    payload: Math.round((totalOut - totalIn) / solarInput * 1000) / 10,\n}, {\n    payload: Math.round(totalOut * 10) / 10,\n}, {\n    payload: Math.round((totalOut - totalIn) * 10) / 10,\n}, {\n    payload: Math.round((totalOut - totalIn) / totalOut * 1000) / 10,\n}]",
        "outputs": 4,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 395,
        "y": 1260,
        "wires": [
            [
                "1989ea913e42d2ba"
            ],
            [
                "619978a8e4ef83cf"
            ],
            [
                "6bf2d8943d15ef7e"
            ],
            [
                "7aab8e59ab7d072b"
            ]
        ],
        "l": false
    },
    {
        "id": "9e2f6b1f33640ffb",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "af294a26a01766cc",
        "order": 2,
        "width": 0,
        "height": 0,
        "name": "used (-31 days)",
        "label": "used",
        "format": "{{msg.payload}} kWh",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 640,
        "y": 1240,
        "wires": []
    },
    {
        "id": "619978a8e4ef83cf",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 490,
        "y": 1240,
        "wires": [
            [
                "9e2f6b1f33640ffb"
            ]
        ]
    },
    {
        "id": "96466a774ca2cfa1",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "af294a26a01766cc",
        "order": 2,
        "width": 0,
        "height": 0,
        "name": "from solar (-31 days)",
        "label": "from solar",
        "format": "{{msg.payload}} kWh",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 660,
        "y": 1280,
        "wires": []
    },
    {
        "id": "6bf2d8943d15ef7e",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 490,
        "y": 1280,
        "wires": [
            [
                "96466a774ca2cfa1"
            ]
        ]
    },
    {
        "id": "e1e4029b2b74655d",
        "type": "ui_text",
        "z": "d02cf25fa8114475",
        "group": "af294a26a01766cc",
        "order": 2,
        "width": 0,
        "height": 0,
        "name": "from solar% (-31 days)",
        "label": "from solar",
        "format": "{{msg.payload}}%",
        "layout": "row-spread",
        "className": "",
        "style": false,
        "font": "",
        "fontSize": 16,
        "color": "#000000",
        "x": 660,
        "y": 1320,
        "wires": []
    },
    {
        "id": "7aab8e59ab7d072b",
        "type": "rbe",
        "z": "d02cf25fa8114475",
        "name": "",
        "func": "rbe",
        "gap": "",
        "start": "",
        "inout": "out",
        "septopics": false,
        "property": "payload",
        "topi": "topic",
        "x": 490,
        "y": 1320,
        "wires": [
            [
                "e1e4029b2b74655d"
            ]
        ]
    },
    {
        "id": "e6892c53b951d955",
        "type": "function",
        "z": "13aa577370e4c4d7",
        "name": "Last Message",
        "func": "const now = new Date();\nconst last = context.get(msg.topic) || {};\nconst span = last ? (now.getTime() - last.lastTick) / 1000 : null;\nconst seconds = last && span ? Math.max(last.seconds ?? 0, span) : null;\n\ncontext.set(msg.topic, {\n    lastTick: now.getTime(),\n    last: now.toLocaleString(),\n    seconds,\n    payload: msg.payload,\n});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 180,
        "wires": [
            [
                "a2c9d6a36b64dbb9"
            ]
        ]
    },
    {
        "id": "46c6a15226b95a40",
        "type": "mqtt in",
        "z": "13aa577370e4c4d7",
        "name": "",
        "topic": "zigbee2mqtt/temp/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 130,
        "y": 140,
        "wires": [
            [
                "e6892c53b951d955"
            ]
        ]
    },
    {
        "id": "3f2e0c17ed43535a",
        "type": "mqtt in",
        "z": "13aa577370e4c4d7",
        "name": "",
        "topic": "zigbee2mqtt/pir/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 120,
        "y": 180,
        "wires": [
            [
                "e6892c53b951d955"
            ]
        ]
    },
    {
        "id": "568b712cbc5d52ec",
        "type": "mqtt in",
        "z": "13aa577370e4c4d7",
        "name": "",
        "topic": "zigbee2mqtt/light/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 130,
        "y": 220,
        "wires": [
            [
                "e6892c53b951d955"
            ]
        ]
    },
    {
        "id": "1432e0debb3006ca",
        "type": "mqtt in",
        "z": "13aa577370e4c4d7",
        "name": "",
        "topic": "zigbee2mqtt/switch/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 140,
        "y": 260,
        "wires": [
            [
                "e6892c53b951d955"
            ]
        ]
    },
    {
        "id": "532c2f5d16d7a052",
        "type": "mqtt in",
        "z": "13aa577370e4c4d7",
        "name": "",
        "topic": "zigbee2mqtt/relay/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 130,
        "y": 300,
        "wires": [
            [
                "e6892c53b951d955"
            ]
        ]
    },
    {
        "id": "684884b00c3e9fad",
        "type": "noraf-notify",
        "z": "13aa577370e4c4d7",
        "tag": "",
        "title": "??",
        "body": "??",
        "icon": "",
        "name": "Notify",
        "nora": "f1e538c1.0315f8",
        "topic": "",
        "actions": [],
        "closeNotification": false,
        "x": 730,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "a2c9d6a36b64dbb9",
        "type": "function",
        "z": "13aa577370e4c4d7",
        "name": "Battery low",
        "func": "if (msg.payload?.battery_low === true ||\n    msg.payload?.battery < 20) {\n    const now = new Date().toLocaleString();\n    const location = msg.topic.substring(msg.topic.indexOf('/') + 1);\n    return {\n        topic: location,\n        payload: {\n            tag: location,\n            title: 'Battery low',\n            body: `${location} at ${now}. Battery: ${msg.payload.battery ?? -1}. Low: ${msg.payload.battery_low}`,\n\n            //zigbee logo\n            icon: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAI+UlEQVR4nO1de6wcZRX/KmrvnLO3KFij+H5iwDdqKkE3e87cctWiRlNiYogaXyCiNhgxxICP4ANUlEciCjZR/xAJmqJoFYLEBI1Jm9qKhtJUsNJ73T3f3tsWQUDomvPNNtDbu7uzO9/sN7OdX3L+uDf3zpzzm2++x3mNMRUqVKhQoUKFChUqVKhQIMzjzDMt0oxF+qQFutoC3SrA2y3SbgFeEKSHnQAvJL+jHQJ0i/tb5PMsNNbO1WZXh7ajNNhr1kEL4ncI0LeVaEE+aJE7WUSvkTwY/o5EjXfuMWui0HYWDgKNUwTouwLUzkp4CnlQgH8mEZ3RMeuPMUcr7jazKyWisy3Q3WMgvYfQbqnF59xj6lPmaIEaq3O6IP8rHPFHPIg5QTpfp0AzyWhB4+2CfE94wrnXenFfu0brzaRBovgEnXdDE2zTy6aFqcYLzCRAInq3AC8WgNTOUG+D6lyL32PKCt1hCPIXBemx0GTaTELX6IbBlAn7Vq09zgLdHp489vU23KE2mTKgCfVn6cGnpzHucEVz7kQLfJsAXa8nV0H+kkX+lAX6oC6Eeopt1egtekZormq85N8r+cV6Mt537GlPX05sRM/Rv2lj42T9H/3fNsZn6jUF+RJB3ihIvxl19yXAf2tPrX2eKTJ04RKgv1vgXYL8awG6wiJ9WgltTzVOVQM65pSnhNZzrja7ug3x6QLx5wVps7ozUj0EpD1SW/sKU1Toa1oEgofF4rH1pwk0zlJfU5qHUPg3ocyQKH6DRb5p0HRUmjVhOeiuogWnP7uNM69s1eJ6C3idm6aAPiJI5wrQBYL0FYv89cOFrul6Og/7va4f7n8S14ZbQ3SK0Ws7P9N040SdHnWtSKtjC+l9/XxTgvTHQu6ODtTqz2hP8Zu7C+AGAb5cgG9QhQX5Xgt8f7AdDdBFw9ii871uGHq/CXSFCYkW0Ou7o/U6RzCQDb1ltD2FvjaKjRLxGwX5kZ7XrfF7TaiRboGa4YnlgaKu7iy2CtJXe1+bF4O4LXRaKQX5SNd1jFmR/WDJB/rc5yYzTmgwoxzk88aOufhJXmxG3tj3XhGdYcaBjqk/WbdhhScf+AbV1Zfduqsa8Kb9YyzhThfsLjz5dKNP8h8PJPGDA+69weQJ3fdapL2hCbb9R+Jm3/tz9exaoJ+kuP98rm9BC+KPFnzk3+I7vqsLuEX6fmodIjrb5/0PVwT4rtAk214CdLvvmG5CPn9vOF1od9Zd17LQY31wkrHHqEP6kxx/6rRvmy3SpaPoo1z51kW3YT8MTbRdfsRty8Mx1u/wNXhA8LXG+w6g/0EkzMgH3r5/mo/PgfwvZ9OL9ntdjNtAbwtNtl0qQDs1+mY8wwJd6EM/9fB6UyqJbBWJfN6lqS7GMzR65+/tpG/5UwxoZ3DSsWsY8r0LU/HzjWcksYjsycCPC23zopgGMfwqlon8+zRAbzzDAn3Yt42ajqMe4+zKufz88ORbdX3X6CTjGRo4EqRHc9I7zqygAH0uNPkCLBq+NJ6hmW+C/L/83lg6N7uSQ58EvZO/0AJ+nfEMifhdfSNdXnT3ELJU51Y48mm/jehNxjN0W502FyjbG8C/zaxsMN8/8P2azOWF8SfagzFb5P+OZwDx9swK98sKyE/oAUFqGM/QBzrOrAwN0mRWWoD2jZN8QXpYpwjjGTaK14zbnaKbh8yK571Q2SXkez3Cd9GEmdeOqQBwidBDmZUfx2JlkwXrES0jNZ6xgPGrQuUrqU2ZDRjHyBGkRzUV0HhGa5pfrmHCEOQ7u4D2ZTbCpRPmTL4gv994Rms6flmYDcQTheYyGyJAf82PfD6ocWbjGeqsK0I1ppdtqOu9UCLybVR/rsZlQ5PflZuzG5Skg3sn34ufZAk05T1s5f0Rdv7AZIWr2/L+atIFJoeyIwG+MzTp3hO1BqXkDS1AF5ocSows8tYCEL7kDfBwmncjy1ewYsgCiSHI31I88vmgt2yNfmWnQ5B/sfGMeTODFvgPocle9gEA7fBmqDY7Khr5e806sEC/D0107wfAl3szVl0ERSJ/j1kTpSkpDSnaGcarwSN5RXMgv2PWP9Ui/TI0wQNG/4LqGTY1MR/yjylD2xvvqYkK3VKFJ5+uD01uGmnVGm/1bb/RWqs0R3xtUZPLvYF/HJrYVKMf+M5c0tMVUuNPDFTAczOLjjEr9JUOTewQD+BjJmSJkqb4eS4KuSo0qemF9uZeqKfdBfuPALrR171s0guiU5rRn1d50tIDUD9fu4bh1CuZ9T6CfEloQocSoJ3et54ZDmaXZbm+BbooOKEhD16pSELe1O8tGDWRVgqQizpInH1Jyv7Nzk0DjQ+ZMO3JerejdKHM42ZXhY492JEIdp0e57ud2n/VLVA5rw0821xVf6nvIvCs2cU9XdUazmyurtfSXKu5ul4TaHxWp6/uqXtTNxy6RfvQCdI/Xct6J7Q/RYNu97cuMJ9EybZok0B1YwjQT5PmT/xN7RtngT+gyWBNaLxG169SNfVOUb60VbsZhtZzsrugA9/R/yHQAxb4C6Xus2YSR+DiypkXaR3wAtKrTVGgxKbLoqb/CPLPLdJnXJ84bJxclI7lWujtesvV4tO0C1Z3PbpM/U/aDUwPWYe6AOvaMEz/ubFAWzlqS8eRFj6gpiD/Wedm9/WMpOXx+Zq2cqgBn/ahSz70cLjobkunOHWB6M8uAxo5PtQIUOd3dQ9oIoBF/ob2fXDNppJ4wlZdW4ZKVwfelUd5rBc4EkZ9CFh8UdsWV9ZfaErQqn77xJEPtKM0DVvdmuDmzYkZ+ZvzaAYyht1RwSrscQQBurowB6+RqxHdgah0xDdVdzMJULfFoH7Mtljyi4n8AJy2dtTCteKOer5rIj/ic0RCFfKGgjX/m5eIPl7quX6kRboWnxM2l5+26SFNUxzN0YqOMStcm3nka8dREtu9x4/0ZB3a9sJhj1kTqQuh6474i68vMCV1A3Sp5jaV8QsfwXBAO7QjzSQfdeArBfh3+mC6n65tJyW09JAFaqmPxsUOtLcF8FU6p6tjrXBOswoVKlSoUKFChQoVKpijHf8HpXkJmmVvB/kAAAAASUVORK5CYII='\n        },\n    };\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 240,
        "wires": [
            [
                "6ac061a53b0101c8"
            ]
        ]
    },
    {
        "id": "6ac061a53b0101c8",
        "type": "trigger",
        "z": "13aa577370e4c4d7",
        "name": "",
        "op1": "",
        "op2": "",
        "op1type": "pay",
        "op2type": "nul",
        "duration": "24",
        "extend": false,
        "overrideDelay": false,
        "units": "hr",
        "reset": "",
        "bytopic": "topic",
        "topic": "topic",
        "outputs": 1,
        "x": 570,
        "y": 240,
        "wires": [
            [
                "684884b00c3e9fad"
            ]
        ]
    },
    {
        "id": "dee09762f6285202",
        "type": "mqtt in",
        "z": "13aa577370e4c4d7",
        "name": "",
        "topic": "zigbee2mqtt/leak/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 130,
        "y": 440,
        "wires": [
            [
                "52228e2e95e8936e",
                "dae1ee13dce83183"
            ]
        ]
    },
    {
        "id": "52228e2e95e8936e",
        "type": "function",
        "z": "13aa577370e4c4d7",
        "name": "leak?",
        "func": "const WAIT_SEC = 20;\nconst ON = {\n    payload: { on: true },\n    topic: 'ha-switch/switch-onoff-r1/state/set',\n};\nconst OFF = {\n    payload: { on: false },\n    topic: ON.topic,\n};\n\nif (msg.payload === 'cancel') {\n    this.timer = null;\n    clearTimeout(this.timer);\n    return;\n}\n\nif (msg.payload === 'start-water') {\n    node.send([, ON]);\n    return;\n}\n\nif (!msg.payload.water_leak || this.timer) {\n    return;\n}\n\nconst time = new Date().toLocaleString();\nconst parts = msg.topic.split('/');\nconst location = parts[parts.length - 1];\n\nconst base = {\n    tag: `water-leak`,\n    title: 'Water Leak',\n    body: `Water leak detected at ${time} - ${location}.`,\n};\n\nthis.timer = setTimeout(() => {\n    this.timer = null;\n    node.send([{\n        payload: {\n            ...base,\n            body: `${base.body} Stopped the water.`,\n            actions: [{\n                title: 'Start',\n                action: 'start-water'\n            }],\n        },\n    }, OFF]);\n}, WAIT_SEC * 1000);\n\nreturn {\n    payload: {\n        ...base,\n        body: `${base.body} Stopping the water in ${WAIT_SEC} sec.`,\n        actions: [{\n            title: 'Cancel',\n            action: 'cancel'\n        }],\n    },\n};\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 440,
        "wires": [
            [
                "c37574baa8bb8ddf"
            ],
            [
                "d02926676f707fa2"
            ]
        ]
    },
    {
        "id": "de7e3a91aee2a01f",
        "type": "mqtt in",
        "z": "13aa577370e4c4d7",
        "name": "",
        "topic": "zigbee2mqtt/leak/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 130,
        "y": 100,
        "wires": [
            [
                "e6892c53b951d955"
            ]
        ]
    },
    {
        "id": "c3038920732427fa",
        "type": "mqtt in",
        "z": "13aa577370e4c4d7",
        "name": "",
        "topic": "zigbee2mqtt/contact/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 140,
        "y": 60,
        "wires": [
            [
                "e6892c53b951d955"
            ]
        ]
    },
    {
        "id": "c37574baa8bb8ddf",
        "type": "noraf-notify",
        "z": "13aa577370e4c4d7",
        "tag": "",
        "title": "??",
        "body": "??",
        "icon": "",
        "name": "Notify",
        "nora": "f1e538c1.0315f8",
        "topic": "",
        "actions": [],
        "closeNotification": false,
        "x": 350,
        "y": 360,
        "wires": [
            [
                "52228e2e95e8936e"
            ]
        ]
    },
    {
        "id": "d02926676f707fa2",
        "type": "mqtt out",
        "z": "13aa577370e4c4d7",
        "name": "",
        "topic": "",
        "qos": "0",
        "retain": "true",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 530,
        "y": 440,
        "wires": []
    },
    {
        "id": "dae1ee13dce83183",
        "type": "function",
        "z": "13aa577370e4c4d7",
        "name": "map",
        "func": "const valueName = msg.topic.split('/').slice(-1)[0];\nif (typeof msg.payload.water_leak !== 'boolean') {\n    return;\n}\n\nreturn {\n    payload: { [valueName]: msg.payload.water_leak ? 1 : 0 },\n    measurement: 'water-leak',\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 500,
        "wires": [
            [
                "92c831e50bcd68a1"
            ]
        ]
    },
    {
        "id": "92c831e50bcd68a1",
        "type": "influxdb out",
        "z": "13aa577370e4c4d7",
        "influxdb": "63bdbe3c09b491f2",
        "name": "db",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "home",
        "bucket": "home",
        "x": 530,
        "y": 500,
        "wires": []
    },
    {
        "id": "fc5820fcf7b1a116",
        "type": "mqtt in",
        "z": "13aa577370e4c4d7",
        "name": "",
        "topic": "zigbee2mqtt/dimmer/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 140,
        "y": 340,
        "wires": [
            [
                "e6892c53b951d955"
            ]
        ]
    },
    {
        "id": "f08cfee748e21645",
        "type": "function",
        "z": "536b0e9eda614fd2",
        "name": "Map",
        "func": "let name = msg.topic.substring(msg.topic.indexOf('/') + 1);\n\nconst PREFIX = '/RESULT';\nif (name.endsWith(PREFIX)) {\n    name = name.substring(0, name.length - PREFIX.length);\n}\n\ncontext.set(name, msg.payload);\n\nconst previousPayload = global.get(name) ?? {};\nconst payload = {\n    ...previousPayload,\n    ...v('temperature'),\n    ...v('humidity'),\n    ...v('state', 'on', p => p === 'ON'),\n    ...v('occupancy'),\n    ...v('brightness', 'brightness', v => Math.round(v / 254 * 100)),\n    online: msg.payload?.online ?? true,\n};\nglobal.set(name, payload);\n\nreturn {\n    payload,\n    topic: msg.topic,\n};\n\n/**\n* @param {string} input\n* @param {string} output\n* @param {(a:any)=>any} transform\n* @returns {Record<string, *>}\n*/\nfunction v(input, output = input, transform = x => x) {\n    if (input in msg.payload) {\n        return {\n            [output]: transform(msg.payload[input])\n        };\n    }\n    return {};\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 155,
        "y": 340,
        "wires": [
            [
                "38687e0ac546600f",
                "939503bc765e4d79"
            ]
        ],
        "l": false
    },
    {
        "id": "38687e0ac546600f",
        "type": "noraf-switch",
        "z": "536b0e9eda614fd2",
        "devicename": "Warm Water Pump",
        "roomhint": "Service Room",
        "name": "",
        "passthru": false,
        "errorifstateunchaged": false,
        "nora": "f1e538c1.0315f8",
        "topic": "zigbee2mqtt/relay/water-pump",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "twofactor": "ack",
        "twofactorpin": "",
        "filter": true,
        "asyncCmd": false,
        "outputs": 1,
        "x": 320,
        "y": 280,
        "wires": [
            [
                "7d559a43a7ec6440"
            ]
        ]
    },
    {
        "id": "7d559a43a7ec6440",
        "type": "function",
        "z": "536b0e9eda614fd2",
        "name": "Map",
        "func": "const payload = {};\n\nconst state = typeof msg.payload === 'boolean'\n    ? msg.payload\n    : msg.payload?.on;\n\nif (typeof state === 'boolean') {\n    payload.state = state ? 'ON' : 'OFF';\n}\n\nif (typeof msg.payload === 'object' &&\n    'brightness' in msg.payload) {\n    payload.brightness = Math.round(msg.payload.brightness / 100 * 254);\n}\n\nreturn {\n    payload,\n    topic: msg.topic + '/set',\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 495,
        "y": 340,
        "wires": [
            [
                "b02b6ceb7687e947"
            ]
        ],
        "l": false
    },
    {
        "id": "b02b6ceb7687e947",
        "type": "mqtt out",
        "z": "536b0e9eda614fd2",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 610,
        "y": 340,
        "wires": []
    },
    {
        "id": "857f019fa5ad8be5",
        "type": "switch",
        "z": "536b0e9eda614fd2",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "regex",
                "v": ".+\\/(relay|dimmer)\\/.+",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": ".+\\/temp\\/.+",
                "vt": "str",
                "case": false
            },
            {
                "t": "regex",
                "v": ".+\\/pir\\/.+",
                "vt": "str",
                "case": false
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 570,
        "y": 120,
        "wires": [
            [
                "9cf17a33d6369750"
            ],
            [
                "591e4bb345a80b08"
            ],
            [
                "2e643a135c0bc68a"
            ]
        ]
    },
    {
        "id": "9cf17a33d6369750",
        "type": "trigger",
        "z": "536b0e9eda614fd2",
        "name": "",
        "op1": "",
        "op2": "{\"online\": false}",
        "op1type": "nul",
        "op2type": "json",
        "duration": "20",
        "extend": true,
        "overrideDelay": false,
        "units": "min",
        "reset": "",
        "bytopic": "topic",
        "topic": "topic",
        "outputs": 1,
        "x": 730,
        "y": 60,
        "wires": [
            [
                "18ee405180e7ef0d"
            ]
        ]
    },
    {
        "id": "591e4bb345a80b08",
        "type": "trigger",
        "z": "536b0e9eda614fd2",
        "name": "",
        "op1": "",
        "op2": "{\"online\": false}",
        "op1type": "nul",
        "op2type": "json",
        "duration": "2.2",
        "extend": true,
        "overrideDelay": false,
        "units": "hr",
        "reset": "",
        "bytopic": "topic",
        "topic": "topic",
        "outputs": 1,
        "x": 730,
        "y": 120,
        "wires": [
            [
                "18ee405180e7ef0d"
            ]
        ]
    },
    {
        "id": "5174cbdc84c9deb9",
        "type": "mqtt in",
        "z": "536b0e9eda614fd2",
        "name": "",
        "topic": "zigbee2mqtt/pir/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 140,
        "y": 80,
        "wires": [
            [
                "59a6f1a86fee64bb"
            ]
        ]
    },
    {
        "id": "c77921bad91a3fd4",
        "type": "mqtt in",
        "z": "536b0e9eda614fd2",
        "name": "",
        "topic": "zigbee2mqtt/temp/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 40,
        "wires": [
            [
                "59a6f1a86fee64bb"
            ]
        ]
    },
    {
        "id": "9e54c33578b35bbc",
        "type": "mqtt in",
        "z": "536b0e9eda614fd2",
        "name": "",
        "topic": "zigbee2mqtt/relay/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 120,
        "wires": [
            [
                "59a6f1a86fee64bb"
            ]
        ]
    },
    {
        "id": "32d650ad5f529b41",
        "type": "mqtt in",
        "z": "536b0e9eda614fd2",
        "name": "",
        "topic": "zigbee2mqtt/light/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 160,
        "wires": [
            [
                "59a6f1a86fee64bb"
            ]
        ]
    },
    {
        "id": "8d660f4ac3640160",
        "type": "link in",
        "z": "536b0e9eda614fd2",
        "name": "link in 6",
        "links": [
            "59a6f1a86fee64bb"
        ],
        "x": 455,
        "y": 120,
        "wires": [
            [
                "857f019fa5ad8be5"
            ]
        ]
    },
    {
        "id": "59a6f1a86fee64bb",
        "type": "link out",
        "z": "536b0e9eda614fd2",
        "name": "z2mqtt",
        "mode": "link",
        "links": [
            "8d660f4ac3640160",
            "556407976cf82dd1"
        ],
        "x": 315,
        "y": 40,
        "wires": []
    },
    {
        "id": "556407976cf82dd1",
        "type": "link in",
        "z": "536b0e9eda614fd2",
        "name": "link in 7",
        "links": [
            "59a6f1a86fee64bb",
            "18ee405180e7ef0d"
        ],
        "x": 75,
        "y": 340,
        "wires": [
            [
                "f08cfee748e21645"
            ]
        ]
    },
    {
        "id": "18ee405180e7ef0d",
        "type": "link out",
        "z": "536b0e9eda614fd2",
        "name": "z2mqtt",
        "mode": "link",
        "links": [
            "556407976cf82dd1"
        ],
        "x": 855,
        "y": 100,
        "wires": []
    },
    {
        "id": "2e643a135c0bc68a",
        "type": "trigger",
        "z": "536b0e9eda614fd2",
        "name": "",
        "op1": "",
        "op2": "{\"online\": false}",
        "op1type": "nul",
        "op2type": "json",
        "duration": "1.5",
        "extend": true,
        "overrideDelay": false,
        "units": "hr",
        "reset": "",
        "bytopic": "topic",
        "topic": "topic",
        "outputs": 1,
        "x": 730,
        "y": 180,
        "wires": [
            [
                "18ee405180e7ef0d"
            ]
        ]
    },
    {
        "id": "939503bc765e4d79",
        "type": "noraf-light",
        "z": "536b0e9eda614fd2",
        "devicename": "Light",
        "lightcolor": false,
        "brightnesscontrol": true,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": true,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Office",
        "name": "office-dimmer",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "zigbee2mqtt/dimmer/office",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 310,
        "y": 340,
        "wires": [
            [
                "7d559a43a7ec6440"
            ]
        ]
    },
    {
        "id": "31934cdca9f932ec",
        "type": "mqtt in",
        "z": "536b0e9eda614fd2",
        "name": "",
        "topic": "zigbee2mqtt/dimmer/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 160,
        "y": 200,
        "wires": [
            [
                "59a6f1a86fee64bb"
            ]
        ]
    },
    {
        "id": "dfca40dd7aa881e6",
        "type": "mqtt in",
        "z": "536b0e9eda614fd2",
        "name": "",
        "topic": "zigbee2mqtt/pir/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 140,
        "y": 540,
        "wires": [
            [
                "8ab75f8eee4ef8d5",
                "a2ce7a8e3f483f80"
            ]
        ]
    },
    {
        "id": "54e506afd7d7a753",
        "type": "mqtt in",
        "z": "536b0e9eda614fd2",
        "name": "",
        "topic": "zigbee2mqtt/contact/+",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 160,
        "y": 480,
        "wires": [
            [
                "d445960ecb358d5a",
                "a2ce7a8e3f483f80"
            ]
        ]
    },
    {
        "id": "6615d0e84e2ff43a",
        "type": "influxdb out",
        "z": "536b0e9eda614fd2",
        "influxdb": "63bdbe3c09b491f2",
        "name": "db",
        "measurement": "",
        "precision": "",
        "retentionPolicy": "",
        "database": "database",
        "precisionV18FluxV20": "ms",
        "retentionPolicyV18Flux": "",
        "org": "home",
        "bucket": "home",
        "x": 530,
        "y": 540,
        "wires": []
    },
    {
        "id": "8ab75f8eee4ef8d5",
        "type": "function",
        "z": "536b0e9eda614fd2",
        "name": "map",
        "func": "const valueName = msg.topic.split('/').slice(-1)[0];\nconst msgs = [];\n\nif (typeof msg.payload.occupancy === 'boolean') {\n    msgs.push({\n        payload: { [valueName]: msg.payload.occupancy ? 1 : 0 },\n        measurement: 'occupancy',\n    });\n}\n\nif (typeof msg.payload.illuminance === 'number') {\n    msgs.push({\n        payload: { [valueName]: msg.payload.illuminance },\n        measurement: 'illuminance',\n    });\n}\n\nreturn [msgs];",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 540,
        "wires": [
            [
                "6615d0e84e2ff43a"
            ]
        ]
    },
    {
        "id": "d445960ecb358d5a",
        "type": "function",
        "z": "536b0e9eda614fd2",
        "name": "map",
        "func": "const valueName = msg.topic.split('/').slice(-1)[0];\nif (typeof msg.payload.contact !== 'boolean') {\n    return;\n}\n\nreturn {\n    payload: { [valueName]: msg.payload.contact ? 1 : 0 },\n    measurement: 'contact',\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 500,
        "wires": [
            [
                "6615d0e84e2ff43a"
            ]
        ]
    },
    {
        "id": "a2ce7a8e3f483f80",
        "type": "link out",
        "z": "536b0e9eda614fd2",
        "name": "contact/pir change",
        "mode": "link",
        "links": [
            "2015749dd862c92d"
        ],
        "x": 355,
        "y": 460,
        "wires": []
    },
    {
        "id": "82ff84e98779afab",
        "type": "google-notify",
        "z": "536b0e9eda614fd2",
        "server": "ea0310ce54c9a43e",
        "label": "Garage",
        "playVolumeLevel": "50",
        "playMessage": "Missing message",
        "language": "config",
        "speakSlow": "config",
        "mediaUrl": "",
        "mediaType": "mp3",
        "x": 740,
        "y": 600,
        "wires": [
            []
        ]
    },
    {
        "id": "191f8ea48fb23429",
        "type": "mqtt in",
        "z": "536b0e9eda614fd2",
        "name": "",
        "topic": "zigbee2mqtt/contact/terasa",
        "qos": "2",
        "datatype": "json",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 170,
        "y": 600,
        "wires": [
            [
                "26a5f218381dfa8a"
            ]
        ]
    },
    {
        "id": "26a5f218381dfa8a",
        "type": "function",
        "z": "536b0e9eda614fd2",
        "name": "map",
        "func": "if (typeof msg.payload.contact !== 'boolean') {\n    return;\n}\n\nreturn msg.payload.contact\n    ? [, {\n        reset: true,\n    }]\n    : {\n        playMessage: 'ușa la terasă este deschisă',\n        language: 'ro',\n        playVolumeLevel: 100,\n    };",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 325,
        "y": 600,
        "wires": [
            [
                "5d98dcd8d55d35db"
            ],
            [
                "58004da352786771",
                "5d98dcd8d55d35db"
            ]
        ],
        "outputLabels": [
            "msg",
            "reset"
        ],
        "l": false
    },
    {
        "id": "5d98dcd8d55d35db",
        "type": "trigger",
        "z": "536b0e9eda614fd2",
        "name": "",
        "op1": "",
        "op2": "",
        "op1type": "nul",
        "op2type": "payl",
        "duration": "30",
        "extend": false,
        "overrideDelay": false,
        "units": "s",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 490,
        "y": 600,
        "wires": [
            [
                "58004da352786771"
            ]
        ]
    },
    {
        "id": "dd3eeb57a2ddeb28",
        "type": "google-notify",
        "z": "536b0e9eda614fd2",
        "server": "dc32c722d4c93816",
        "label": "Kitchen",
        "playVolumeLevel": "50",
        "playMessage": "Missing message",
        "language": "config",
        "speakSlow": "config",
        "mediaUrl": "",
        "mediaType": "mp3",
        "x": 740,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "28ec26da620b00de",
        "type": "google-notify",
        "z": "536b0e9eda614fd2",
        "server": "75f9992b7ac7471e",
        "label": "Bedroom",
        "playVolumeLevel": "50",
        "playMessage": "Missing message",
        "language": "config",
        "speakSlow": "config",
        "mediaUrl": "",
        "mediaType": "mp3",
        "x": 740,
        "y": 720,
        "wires": [
            []
        ]
    },
    {
        "id": "58004da352786771",
        "type": "trigger",
        "z": "536b0e9eda614fd2",
        "name": "",
        "op1": "",
        "op2": "0",
        "op1type": "pay",
        "op2type": "str",
        "duration": "-10",
        "extend": false,
        "overrideDelay": false,
        "units": "s",
        "reset": "",
        "bytopic": "all",
        "topic": "topic",
        "outputs": 1,
        "x": 510,
        "y": 660,
        "wires": [
            [
                "82ff84e98779afab",
                "dd3eeb57a2ddeb28",
                "28ec26da620b00de"
            ]
        ]
    },
    {
        "id": "244c26807bc68f0e",
        "type": "sunrise",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "lat": "45.977066",
        "lon": "21.316671",
        "start": "dawn",
        "end": "sunset",
        "soff": "10",
        "eoff": "15",
        "x": 130,
        "y": 60,
        "wires": [
            [
                "69c3544ee94c90d3"
            ],
            []
        ]
    },
    {
        "id": "4c7198dcb8cd0684",
        "type": "function",
        "z": "67e1c6f6bd2fab57",
        "name": "outside light on/off",
        "func": "if (msg.topic === 'dark') {\n    context.set('darkOutside', !msg.payload);\n}\n\nconst lightOn =\n    context.get('darkOutside') &&\n    flow.get('autoLightOutside');\n\nturn(lightOn);\n\n/**\n * @param {boolean} on\n */\nfunction turn(on) {\n    node.send([[\n        {\n            payload: { on },\n            topic: 'ha-switch/switch-dimmer-11/state/set',\n            retain: true,\n        },\n        {\n            payload: { on: [on] },\n            topic: 'ha-switch/switch-onoff-7/state/set',\n            retain: true,\n        },\n        {\n            topic: 'zigbee2mqtt-garage/light/outside/set',\n            payload: { state: on ? 'ON' : 'OFF' },\n        },\n        ...getDeckMessages(on),\n    ]]);\n}\n\nfunction getDeckMessages(on) {\n    const deckBase = 'cmnd/dimmer_terasa/';\n    const deckDimmer = `${deckBase}/Dimmer`;\n    const deckPower = `${deckBase}/Power`;\n    return on\n        ? [{\n            topic: deckPower,\n            payload: 'ON',\n        }, {\n            topic: deckDimmer,\n            payload: 15,\n        }]\n        : [{\n            topic: deckPower,\n            payload: 'OFF',\n        }];\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 100,
        "wires": [
            [
                "bdccd9d28e3a0e9a"
            ]
        ]
    },
    {
        "id": "bdccd9d28e3a0e9a",
        "type": "mqtt out",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "topic": "",
        "qos": "1",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 550,
        "y": 80,
        "wires": []
    },
    {
        "id": "0d243166fa4cb451",
        "type": "function",
        "z": "67e1c6f6bd2fab57",
        "name": "open/close blinds",
        "func": "/** @type boolean */\nconst away = global.get('awayMode');\n\n/** @type Array<{id: number, open?:number, close?: number, openLater?: number}> */\nconst BLINDS = [\n    { id: 1, open: 15, openLater: 100, close: 0 }, // guest\n    { id: 2, open: 100, close: 0 }, // kitchen-window\n    { id: 8, open: 15, close: 0 }, // kitchen-fixed\n    { id: 3, open: away && 15, openLater: away ? 80 : 40, close: 0 }, // big bedroom\n    { id: 4, open: 100 }, // living-door\n    { id: 6, open: 40, openLater: away ? 80 : 100, close: away ? 15 : 0 }, // living-window\n    { id: 5, open: 100, close: 0 }, // office\n];\n\nconst KEY = 'blindsLastCommand';\n\n/** @type {'open'|'close'|'openLater'} */\n\nif (!msg.payload) {\n    blinds('close');\n} else {\n    const now = new Date();\n    const minTimeToOpenBlinds = new Date();\n    minTimeToOpenBlinds.setHours(7, 30, 0);\n\n    const openLaterTime = new Date();\n    openLaterTime.setHours(8, 30, 0);\n\n    if (now >= minTimeToOpenBlinds && now < openLaterTime) {\n        blinds('open');\n    } else if (now >= openLaterTime) {\n        blinds('openLater');\n    }\n}\n\n/** @param {'open'|'close'|'openLater'} type */\nfunction blinds(type) {\n    const last = context.get(KEY);\n    if (type === last) {\n        return;\n    }\n\n    // if (type.startsWith('open') && global.get('outdoorTemperature') <= 0) {\n    //     return;\n    // }\n\n    context.set(KEY, type);\n\n    if (type.startsWith('open') && !flow.get('autoOpenBlinds')) {\n        return;\n    }\n\n    const msgs = BLINDS\n        .map(b => {\n            const stateTopic = `ha-switch/switch-blinds-${b.id}/state`;\n            const currentState = global.get(stateTopic);\n\n            const openPercent = b[type];\n            if (typeof openPercent !== 'number') {\n                return;\n            }\n\n            if (currentState) {\n                switch (type) {\n                    case 'open':\n                    case 'openLater':\n                        if (openPercent <= currentState.openPercent) {\n                            return;\n                        }\n                        break;\n                    case 'close':\n                        if (openPercent >= currentState.openPercent) {\n                            //blinds are already more closed\n                            return;\n                        }\n                        break;\n                }\n            }\n\n            return {\n                payload: { openPercent },\n                topic: `${stateTopic}/set`,\n                retain: true,\n            };\n        })\n        .filter(m => !!m);\n    node.send([msgs]);\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 140,
        "wires": [
            [
                "11e1c771398804b4"
            ]
        ]
    },
    {
        "id": "11e1c771398804b4",
        "type": "mqtt out",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "topic": "",
        "qos": "1",
        "retain": "true",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 550,
        "y": 140,
        "wires": []
    },
    {
        "id": "4929a74e2d6431e1",
        "type": "sunrise",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "lat": "45.977066",
        "lon": "21.316671",
        "start": "sunrise",
        "end": "sunset",
        "soff": "-15",
        "eoff": "0",
        "x": 130,
        "y": 140,
        "wires": [
            [
                "0d243166fa4cb451"
            ],
            []
        ]
    },
    {
        "id": "d2abff84dd6c4311",
        "type": "noraf-switch",
        "z": "67e1c6f6bd2fab57",
        "devicename": "Auto Open Blinds",
        "roomhint": "Service Room",
        "name": "",
        "passthru": false,
        "errorifstateunchaged": false,
        "nora": "f1e538c1.0315f8",
        "topic": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "twofactor": "ack",
        "twofactorpin": "",
        "filter": false,
        "asyncCmd": false,
        "outputs": 1,
        "x": 1030,
        "y": 300,
        "wires": [
            [
                "1d90fcaf445ae7bc"
            ]
        ]
    },
    {
        "id": "1d90fcaf445ae7bc",
        "type": "change",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "autoOpenBlinds",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1250,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "3a78bf2365a4ccba",
        "type": "noraf-switch",
        "z": "67e1c6f6bd2fab57",
        "devicename": "Away Mode",
        "roomhint": "Service Room",
        "name": "",
        "passthru": false,
        "errorifstateunchaged": false,
        "nora": "f1e538c1.0315f8",
        "topic": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "twofactor": "ack",
        "twofactorpin": "",
        "filter": false,
        "asyncCmd": false,
        "outputs": 1,
        "x": 1010,
        "y": 360,
        "wires": [
            [
                "11be8070cc0b6078"
            ]
        ]
    },
    {
        "id": "11be8070cc0b6078",
        "type": "change",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "awayMode",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1240,
        "y": 360,
        "wires": [
            [
                "b5c38b7ad5256cd1"
            ]
        ]
    },
    {
        "id": "e1a0476c7e29f306",
        "type": "cronplus",
        "z": "67e1c6f6bd2fab57",
        "name": "water pump",
        "outputField": "payload",
        "timeZone": "",
        "persistDynamic": false,
        "commandResponseMsgOutput": "output1",
        "outputs": 1,
        "options": [
            {
                "name": "turn on",
                "topic": "cron",
                "payloadType": "bool",
                "payload": "true",
                "expressionType": "cron",
                "expression": "0 0 7 ? * * *",
                "location": "",
                "offset": "0",
                "solarType": "all",
                "solarEvents": "sunrise,sunset"
            },
            {
                "name": "turn off",
                "topic": "cron",
                "payloadType": "bool",
                "payload": "false",
                "expressionType": "cron",
                "expression": "0 0 22 ? * * *",
                "location": "",
                "offset": "0",
                "solarType": "all",
                "solarEvents": "sunrise,sunset"
            }
        ],
        "x": 130,
        "y": 220,
        "wires": [
            [
                "024bfe1bb1739127"
            ]
        ]
    },
    {
        "id": "b6cc3dcb19c105e1",
        "type": "mqtt out",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "topic": "",
        "qos": "1",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 550,
        "y": 200,
        "wires": []
    },
    {
        "id": "024bfe1bb1739127",
        "type": "function",
        "z": "67e1c6f6bd2fab57",
        "name": "check away mode",
        "func": "if (msg.topic === 'cron') {\n    context.set('cron', msg.payload);\n}\n\nconst state = global.get('awayMode')\n    ? 'OFF'\n    : (context.get('cron') ? 'ON' : 'OFF');\n\nreturn {\n    topic: 'zigbee2mqtt/relay/water-pump/set',\n    payload: { state },\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 200,
        "wires": [
            [
                "b6cc3dcb19c105e1"
            ]
        ]
    },
    {
        "id": "a0bf8cda615f1687",
        "type": "function",
        "z": "67e1c6f6bd2fab57",
        "name": "lights on/off when motion or contact",
        "func": "if (!flow.get('auto_light')) {\n    return;\n}\n\n/**\n * @type Array<{\n *  src:Array<string>, \n *  target:string, \n *  timeoutMin: number, \n *  turn:'on'|'off'\n * }>\n */\nconst targetByPir = [\n    {\n        src: ['pir/hallway-1', 'pir/hallway-2'],\n        target: 'switch-dimmer-3',\n        timeoutMin: 1,\n        turn: 'on',\n    }, {\n        src: ['pir/hallway-3', 'contact/entrance'],\n        target: 'switch-dimmer-10',\n        timeoutMin: 3,\n        turn: 'on',\n    }, {\n        src: ['pir/small-bathroom'],\n        target: 'switch-onoff-3',\n        timeoutMin: 15,\n        turn: 'off',\n    }, {\n        src: ['pir/washer-room'],\n        target: 'switch-onoff-9',\n        timeoutMin: 15,\n        turn: 'off',\n    }\n]\n\nconst name = msg.topic.split('/').slice(1).join('/');\nconst found = targetByPir.find(t => t.src.includes(name));\nif (!found) {\n    return;\n}\n\nconst p = msg.payload;\nif (found.turn === 'on') {\n    let turnOn = false;\n\n    if ('occupancy' in p) {\n        const last = context.get(`last-${name}`);\n        if (p.occupancy || last) {\n            turnOn = true;\n        }\n        context.set(`last-${name}`, p.occupancy);\n    }\n\n    if ('contact' in p) {\n        const last = context.get(`last-${name}`);\n        if (p.contact !== last) {\n            turnOn = true;\n        }\n        context.set(`last-${name}`, p.contact);\n    }\n\n    if (turnOn) {\n        return {\n            payload: {\n                'brightness': 100,\n                'for': found.timeoutMin * 60,\n            },\n            topic: `ha-switch/${found.target}/state/set`,\n            retain: false,\n        };\n    }\n} else if (found.turn === 'off') {\n    if (p.occupancy) {\n        return [, {\n            reset: true,\n            topic: `ha-switch/${found.target}/state/set`,\n        }];\n    } else {\n        return [, {\n            payload: {\n                on: false\n            },\n            delay: found.timeoutMin * 60 * 1000,\n            topic: `ha-switch/${found.target}/state/set`,\n            retain: true,\n        }];\n    }\n}\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 440,
        "wires": [
            [
                "05ebecdb8b80ec34"
            ],
            [
                "4d1c7f5bb7516b99"
            ]
        ],
        "outputLabels": [
            "battery low",
            ""
        ]
    },
    {
        "id": "05ebecdb8b80ec34",
        "type": "mqtt out",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "topic": "",
        "qos": "1",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 710,
        "y": 440,
        "wires": []
    },
    {
        "id": "4d1c7f5bb7516b99",
        "type": "trigger",
        "z": "67e1c6f6bd2fab57",
        "name": "wait for delay",
        "op1": "",
        "op2": "",
        "op1type": "nul",
        "op2type": "payl",
        "duration": "1",
        "extend": true,
        "overrideDelay": true,
        "units": "min",
        "reset": "",
        "bytopic": "topic",
        "topic": "topic",
        "outputs": 1,
        "x": 550,
        "y": 460,
        "wires": [
            [
                "05ebecdb8b80ec34"
            ]
        ]
    },
    {
        "id": "5363e241ad979a02",
        "type": "noraf-switch",
        "z": "67e1c6f6bd2fab57",
        "devicename": "Auto light",
        "roomhint": "Service Room",
        "name": "",
        "passthru": false,
        "errorifstateunchaged": false,
        "nora": "f1e538c1.0315f8",
        "topic": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "twofactor": "ack",
        "twofactorpin": "",
        "filter": false,
        "asyncCmd": false,
        "outputs": 1,
        "x": 1000,
        "y": 420,
        "wires": [
            [
                "54830d2c3b73bb4b"
            ]
        ]
    },
    {
        "id": "54830d2c3b73bb4b",
        "type": "change",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "auto_light",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1230,
        "y": 420,
        "wires": [
            []
        ]
    },
    {
        "id": "b5c38b7ad5256cd1",
        "type": "link out",
        "z": "67e1c6f6bd2fab57",
        "name": "link out 26",
        "mode": "link",
        "links": [
            "9bd27251077c6872"
        ],
        "x": 1395,
        "y": 360,
        "wires": []
    },
    {
        "id": "9bd27251077c6872",
        "type": "link in",
        "z": "67e1c6f6bd2fab57",
        "name": "link in 25",
        "links": [
            "b5c38b7ad5256cd1"
        ],
        "x": 185,
        "y": 180,
        "wires": [
            [
                "024bfe1bb1739127"
            ]
        ]
    },
    {
        "id": "026825aac4b94aab",
        "type": "noraf-switch",
        "z": "67e1c6f6bd2fab57",
        "devicename": "Auto light outside",
        "roomhint": "Service Room",
        "name": "",
        "passthru": false,
        "errorifstateunchaged": false,
        "nora": "f1e538c1.0315f8",
        "topic": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "twofactor": "ack",
        "twofactorpin": "",
        "filter": false,
        "asyncCmd": false,
        "outputs": 1,
        "x": 1030,
        "y": 480,
        "wires": [
            [
                "8919162c9e372e17"
            ]
        ]
    },
    {
        "id": "8919162c9e372e17",
        "type": "change",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "autoLightOutside",
                "pt": "flow",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1250,
        "y": 480,
        "wires": [
            [
                "149dc9de744c7ea6"
            ]
        ]
    },
    {
        "id": "69c3544ee94c90d3",
        "type": "function",
        "z": "67e1c6f6bd2fab57",
        "name": "t",
        "func": "return {\n    ...msg,\n    topic: 'dark',\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 60,
        "wires": [
            [
                "4c7198dcb8cd0684"
            ]
        ]
    },
    {
        "id": "2278dce6a6784ffa",
        "type": "link in",
        "z": "67e1c6f6bd2fab57",
        "name": "link in 26",
        "links": [
            "149dc9de744c7ea6"
        ],
        "x": 185,
        "y": 100,
        "wires": [
            [
                "4c7198dcb8cd0684"
            ]
        ]
    },
    {
        "id": "149dc9de744c7ea6",
        "type": "link out",
        "z": "67e1c6f6bd2fab57",
        "name": "link out 27",
        "mode": "link",
        "links": [
            "2278dce6a6784ffa"
        ],
        "x": 1395,
        "y": 480,
        "wires": []
    },
    {
        "id": "dc6b8e05d474395b",
        "type": "function",
        "z": "67e1c6f6bd2fab57",
        "name": "not away mode",
        "func": "if (!global.get('awayMode') &&\n    !msg.payload &&\n    global.get('batteryCapacity') > 96 &&\n    !global.get('estimatedSolarProduction')) {\n    return {\n        payload: 1,\n        topic: 'more-hot-water',\n    };\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 360,
        "wires": [
            [
                "795f23756f1e446b"
            ]
        ]
    },
    {
        "id": "aaa3681ec3f652fe",
        "type": "sunrise",
        "z": "67e1c6f6bd2fab57",
        "name": "~ 3h before sunset",
        "lat": "45.977066",
        "lon": "21.316671",
        "start": "dawn",
        "end": "sunsetStart",
        "soff": "0",
        "eoff": "-180",
        "x": 150,
        "y": 360,
        "wires": [
            [],
            [
                "dc6b8e05d474395b"
            ]
        ]
    },
    {
        "id": "795f23756f1e446b",
        "type": "link out",
        "z": "67e1c6f6bd2fab57",
        "name": "link out 28",
        "mode": "link",
        "links": [
            "9f8ecdb12e5082f5"
        ],
        "x": 485,
        "y": 360,
        "wires": []
    },
    {
        "id": "2015749dd862c92d",
        "type": "link in",
        "z": "67e1c6f6bd2fab57",
        "name": "link in 34",
        "links": [
            "a2ce7a8e3f483f80"
        ],
        "x": 75,
        "y": 440,
        "wires": [
            [
                "a0bf8cda615f1687"
            ]
        ]
    },
    {
        "id": "44f03731dd6e3522",
        "type": "inject",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"value\":0}",
        "payloadType": "json",
        "x": 320,
        "y": 720,
        "wires": [
            [
                "e40c577b424939c9"
            ]
        ]
    },
    {
        "id": "e40c577b424939c9",
        "type": "mqtt out",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "topic": "ha-vent/state/set",
        "qos": "0",
        "retain": "true",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 570,
        "y": 700,
        "wires": []
    },
    {
        "id": "9994256e79b7d045",
        "type": "inject",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"value\":100}",
        "payloadType": "json",
        "x": 330,
        "y": 800,
        "wires": [
            [
                "e40c577b424939c9"
            ]
        ]
    },
    {
        "id": "4e718508101f8074",
        "type": "mqtt in",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "topic": "ha-vent/online",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 840,
        "wires": [
            [
                "b6abe71a4ff1687d"
            ]
        ]
    },
    {
        "id": "b6abe71a4ff1687d",
        "type": "debug",
        "z": "67e1c6f6bd2fab57",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 320,
        "y": 840,
        "wires": []
    },
    {
        "id": "e2a0e25f997986ea",
        "type": "inject",
        "z": "67e1c6f6bd2fab57",
        "name": "every min",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "60",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 150,
        "y": 660,
        "wires": [
            [
                "0a7e8a5273220a20"
            ]
        ]
    },
    {
        "id": "0a7e8a5273220a20",
        "type": "function",
        "z": "67e1c6f6bd2fab57",
        "name": "map",
        "func": "const now = new Date();\nconst isWorkingDay = now.getDay() >= 1 && now.getDay() <= 5;\nconst isWorkingHour = now.getHours() >= 9 && now.getHours() <= 20;\n\n// percentage of an hour that should be on\nconst timeSpentOn = isWorkingDay && isWorkingHour\n    ? .15\n    : .05;\n\nconst isAway = !!global.get('awayMode');\nconst dutyOn = now.getMinutes() <= timeSpentOn * 60;\nconst shouldBeOn = !isAway && dutyOn;\nconst value = shouldBeOn ? 100 : 0;\n\nconst lastValue = context.get('lastValue');\nif (lastValue === value) {\n    return;\n}\n\ncontext.set('lastValue', value);\nnode.status({\n    fill: 'blue',\n    text: `${shouldBeOn ? 'on' : 'off'} - ${timeSpentOn * 100}% duty`\n});\n\nreturn { payload: { value } };\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 660,
        "wires": [
            [
                "e40c577b424939c9"
            ]
        ]
    },
    {
        "id": "9ea23f458493db4e",
        "type": "inject",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"value\":50}",
        "payloadType": "json",
        "x": 330,
        "y": 760,
        "wires": [
            [
                "e40c577b424939c9"
            ]
        ]
    },
    {
        "id": "f776e992d6a065f5",
        "type": "mqtt in",
        "z": "67e1c6f6bd2fab57",
        "name": "",
        "topic": "ha-vent/state",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 900,
        "wires": [
            [
                "b6abe71a4ff1687d"
            ]
        ]
    },
    {
        "id": "c0db6845e0edacfa",
        "type": "mqtt in",
        "z": "86c7bfe22f048e9c",
        "name": "",
        "topic": "stat/+/RESULT",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "f569d34c.8c7ed",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 120,
        "y": 80,
        "wires": [
            [
                "0a7858e8806c0752",
                "527b1b616ecc0448"
            ]
        ]
    },
    {
        "id": "0a7858e8806c0752",
        "type": "function",
        "z": "86c7bfe22f048e9c",
        "name": "map",
        "func": "const start = msg.topic.indexOf('/') + 1;\nconst deviceName = msg.topic.substring(start, msg.topic.lastIndexOf('/'));\n\nlet state = flow.get(deviceName) ?? {};\nstate = {\n    ...state,\n    ...('POWER' in msg.payload ? { on: msg.payload.POWER == 'ON' } : {}),\n    ...('Dimmer' in msg.payload ? { brightness: msg.payload.Dimmer } : {}),\n    online: 'online' in msg.payload ? msg.payload.online : true,\n};\nflow.set(deviceName, state);\n\nreturn {\n    payload: state,\n    topic: deviceName,\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 80,
        "wires": [
            [
                "31a7614427673b14",
                "9b1fa38348a4bbe9",
                "c9f86e52c399a757"
            ]
        ]
    },
    {
        "id": "07e1d3f3b09b4c2f",
        "type": "mqtt out",
        "z": "86c7bfe22f048e9c",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 450,
        "y": 300,
        "wires": []
    },
    {
        "id": "724ffcb347b98a4b",
        "type": "function",
        "z": "86c7bfe22f048e9c",
        "name": "map",
        "func": "const deviceName = msg.topic;\nconst state = flow.get(deviceName);\n\nconst messages = [{\n    payload: msg.payload.on ? 'ON' : 'OFF',\n    topic: `cmnd/${deviceName}/Power`,\n}];\n\nif (msg.payload.brightness !== state?.brightness) {\n    messages.push({\n        payload: msg.payload.brightness,\n        topic: `cmnd/${deviceName}/Dimmer`,\n    });\n}\n\nreturn [messages];",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 650,
        "y": 80,
        "wires": [
            [
                "0c205481e356f2f9"
            ]
        ]
    },
    {
        "id": "527b1b616ecc0448",
        "type": "trigger",
        "z": "86c7bfe22f048e9c",
        "name": "",
        "op1": "",
        "op2": "{\"online\": false}",
        "op1type": "nul",
        "op2type": "json",
        "duration": "2",
        "extend": true,
        "overrideDelay": false,
        "units": "min",
        "reset": "",
        "bytopic": "topic",
        "topic": "topic",
        "outputs": 1,
        "x": 190,
        "y": 140,
        "wires": [
            [
                "0a7858e8806c0752"
            ]
        ]
    },
    {
        "id": "31a7614427673b14",
        "type": "noraf-light",
        "z": "86c7bfe22f048e9c",
        "devicename": "Deck Light",
        "lightcolor": false,
        "brightnesscontrol": true,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": false,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Outside",
        "name": "",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "dimmer_terasa",
        "onvalue": "true",
        "onvalueType": "bool",
        "offvalue": "false",
        "offvalueType": "bool",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 490,
        "y": 80,
        "wires": [
            [
                "724ffcb347b98a4b"
            ]
        ]
    },
    {
        "id": "0c205481e356f2f9",
        "type": "mqtt out",
        "z": "86c7bfe22f048e9c",
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 790,
        "y": 80,
        "wires": []
    },
    {
        "id": "9b1fa38348a4bbe9",
        "type": "noraf-light",
        "z": "86c7bfe22f048e9c",
        "devicename": "Lamp",
        "lightcolor": false,
        "brightnesscontrol": false,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": false,
        "passthru": false,
        "errorifstateunchaged": true,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "Living Room",
        "name": "",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "power_t1",
        "onvalue": "{\"on\": true}",
        "onvalueType": "json",
        "offvalue": "{\"on\": false}",
        "offvalueType": "json",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 470,
        "y": 140,
        "wires": [
            [
                "724ffcb347b98a4b"
            ]
        ]
    },
    {
        "id": "fd78c10160589955",
        "type": "function",
        "z": "86c7bfe22f048e9c",
        "name": "query",
        "func": "const keys = flow.keys();\n\nconst queryTopics = [];\n\nfor (const key of keys) {\n    const state = flow.get(key);\n\n    if (typeof state !== 'object') {\n        continue;\n    }\n\n    if ('on' in state) {\n        queryTopics.push(`cmnd/${key}/Power`);\n    }\n\n    if ('brightness' in state || key.indexOf('dimmer') >= 0) {\n        queryTopics.push(`cmnd/${key}/Dimmer`);\n    }\n}\n\nif (queryTopics.length) {\n    return [queryTopics.map(q => ({\n        payload: '',\n        topic: q,\n    }))];\n}",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 300,
        "wires": [
            [
                "07e1d3f3b09b4c2f"
            ]
        ]
    },
    {
        "id": "e181aecc22b289f2",
        "type": "inject",
        "z": "86c7bfe22f048e9c",
        "name": "periodic",
        "props": [],
        "repeat": "60",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 160,
        "y": 300,
        "wires": [
            [
                "fd78c10160589955"
            ]
        ]
    },
    {
        "id": "c9f86e52c399a757",
        "type": "noraf-light",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "devicename": "Power 3",
        "lightcolor": false,
        "brightnesscontrol": false,
        "commandonlycolor": false,
        "turnonwhenbrightnesschanges": false,
        "passthru": false,
        "errorifstateunchaged": false,
        "statepayload": true,
        "brightnessoverride": "",
        "roomhint": "",
        "name": "",
        "colortype": "hsv",
        "nora": "f1e538c1.0315f8",
        "topic": "power_t3",
        "onvalue": "{\"on\": true}",
        "onvalueType": "json",
        "offvalue": "{\"on\": false}",
        "offvalueType": "json",
        "temperaturemin": "2700",
        "temperaturemax": "5500",
        "twofactor": "off",
        "twofactorpin": "",
        "filter": true,
        "x": 480,
        "y": 200,
        "wires": [
            [
                "724ffcb347b98a4b"
            ]
        ]
    },
    {
        "id": "100e31a6d22519ca",
        "type": "inject",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 16 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "cmnd/power_t3/Power",
        "payload": "ON",
        "payloadType": "str",
        "x": 200,
        "y": 400,
        "wires": [
            [
                "b0855dd761eb9773"
            ]
        ]
    },
    {
        "id": "b0855dd761eb9773",
        "type": "delay",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "name": "",
        "pauseType": "random",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "10",
        "randomLast": "60",
        "randomUnits": "minutes",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 440,
        "y": 420,
        "wires": [
            [
                "45de3d575fa6a2fe"
            ]
        ]
    },
    {
        "id": "c4740cef8210c17e",
        "type": "inject",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 07 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "cmnd/power_t3/Power",
        "payload": "OFF",
        "payloadType": "str",
        "x": 200,
        "y": 440,
        "wires": [
            [
                "b0855dd761eb9773"
            ]
        ]
    },
    {
        "id": "45de3d575fa6a2fe",
        "type": "mqtt out",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 590,
        "y": 420,
        "wires": []
    },
    {
        "id": "372b662bbbeed24b",
        "type": "inject",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "name": "hol:on",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 18 * * *",
        "once": false,
        "onceDelay": 0.1,
        "topic": "ha-switch/switch-dimmer-3/state/set",
        "payload": "{\"on\":true}",
        "payloadType": "json",
        "x": 160,
        "y": 520,
        "wires": [
            [
                "07a01e5055ca9c81"
            ]
        ]
    },
    {
        "id": "67f8da9e71b9f7b5",
        "type": "inject",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "name": "hol:off",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "00 21 * * *",
        "once": true,
        "onceDelay": 0.1,
        "topic": "ha-switch/switch-dimmer-3/state/set",
        "payload": "{\"on\":false}",
        "payloadType": "json",
        "x": 160,
        "y": 560,
        "wires": [
            [
                "07a01e5055ca9c81"
            ]
        ]
    },
    {
        "id": "07a01e5055ca9c81",
        "type": "delay",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "name": "",
        "pauseType": "random",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "10",
        "randomLast": "60",
        "randomUnits": "minutes",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 340,
        "y": 540,
        "wires": [
            [
                "42e405e57785c4bf"
            ]
        ]
    },
    {
        "id": "42e405e57785c4bf",
        "type": "mqtt out",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "name": "",
        "topic": "",
        "qos": "",
        "retain": "true",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "f569d34c.8c7ed",
        "x": 490,
        "y": 540,
        "wires": []
    },
    {
        "id": "bbbdecb1cda7db5e",
        "type": "noraf-doorbell",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "devicename": "Doorbell",
        "roomhint": "",
        "name": "",
        "nora": "3302889fa9b7cb44",
        "topic": "",
        "filter": false,
        "x": 580,
        "y": 700,
        "wires": []
    },
    {
        "id": "7dc0804a1cdeba54",
        "type": "inject",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "name": "\"Alice\" is at the doorbell",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"named\":[\"Alice\"]}",
        "payloadType": "json",
        "x": 220,
        "y": 660,
        "wires": [
            [
                "bbbdecb1cda7db5e"
            ]
        ]
    },
    {
        "id": "1b08bca9fd2551e9",
        "type": "inject",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "name": "someone's at the doorbell (unclassified)",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"unclassified\":1}",
        "payloadType": "json",
        "x": 270,
        "y": 740,
        "wires": [
            [
                "bbbdecb1cda7db5e"
            ]
        ]
    },
    {
        "id": "71629549d9fd9dc9",
        "type": "inject",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "name": "someone you know is at the doorbell",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"familiar\":1}",
        "payloadType": "json",
        "x": 260,
        "y": 700,
        "wires": [
            [
                "bbbdecb1cda7db5e"
            ]
        ]
    },
    {
        "id": "aeeedb84a9e88d39",
        "type": "inject",
        "z": "86c7bfe22f048e9c",
        "d": true,
        "name": "someone's at the doorbell (unfamiliar)",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"unfamiliar\":1}",
        "payloadType": "json",
        "x": 270,
        "y": 780,
        "wires": [
            [
                "bbbdecb1cda7db5e"
            ]
        ]
    }
]